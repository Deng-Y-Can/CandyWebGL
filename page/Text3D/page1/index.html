<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3Dç²’å­æ— äººæœºè¡¨æ¼”æ¨¡æ‹Ÿå™¨</title>
    <!-- å¼•å…¥Three.jsåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Inter', 'Arial', sans-serif;
            transition: all 0.25s ease;
        }

        body {
            background: #020617; /* æ·±ç©ºé»‘èƒŒæ™¯ */
            min-height: 100vh;
            color: #e2e8f0;
            overflow-x: hidden;
            position: relative;
        }

        /* 3Dåœºæ™¯å®¹å™¨ - å…¨å±æ˜¾ç¤º */
        #scene-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            cursor: grab;
            z-index: 1;
        }

            #scene-container:active {
                cursor: grabbing;
            }

        /* é¡¶éƒ¨æ§åˆ¶æ  - æ‚¬æµ®å±…ä¸­ */
        .top-controls {
            position: fixed;
            top: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(16px);
            border-radius: 16px;
            padding: 12px 24px;
            display: flex;
            gap: 18px;
            align-items: center;
            z-index: 10;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .control-btn {
            padding: 10px 18px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            background: #3b82f6;
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

            .control-btn:hover {
                background: #2563eb;
                transform: translateY(-2px);
                box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
            }

            .control-btn:disabled {
                background: #475569;
                color: #94a3b8;
                cursor: not-allowed;
                transform: none;
                box-shadow: none;
            }

            .control-btn.secondary {
                background: rgba(255, 255, 255, 0.1);
                color: #e2e8f0;
                box-shadow: none;
            }

                .control-btn.secondary:hover {
                    background: rgba(255, 255, 255, 0.15);
                    box-shadow: none;
                }

        /* æ’­æ”¾é€Ÿåº¦æ§åˆ¶ */
        .speed-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

            .speed-control label {
                font-size: 14px;
                color: #cbd5e1;
                white-space: nowrap;
            }

            .speed-control input {
                width: 120px;
                accent-color: #3b82f6;
            }

        /* çŠ¶æ€æç¤º */
        .status-hint {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(8px);
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            color: #94a3b8;
            z-index: 10;
            border: 1px solid rgba(255, 255, 255, 0.05);
            opacity: 0;
            pointer-events: none;
        }

            .status-hint.show {
                opacity: 1;
                pointer-events: auto;
            }

        /* ç¼–è¾‘é¢æ¿ - åº•éƒ¨æŠ½å±‰å¼å¼¹çª— */
        .editor-drawer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100vw;
            max-height: 90vh;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(16px);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.4);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 20;
            transform: translateY(100%); /* é»˜è®¤éšè— */
            overflow: hidden;
        }

            .editor-drawer.open {
                transform: translateY(0); /* æ‰“å¼€æ—¶æ»‘å…¥ */
            }

        /* æŠ½å±‰å¤´éƒ¨ */
        .drawer-header {
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .drawer-title {
            font-size: 18px;
            font-weight: 600;
            color: #f1f5f9;
        }

        .drawer-actions {
            display: flex;
            gap: 12px;
        }

        .drawer-btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            cursor: pointer;
        }

        /* æŠ½å±‰å†…å®¹åŒº */
        .drawer-content {
            padding: 24px;
            overflow-y: auto;
            max-height: calc(90vh - 70px);
        }

            .drawer-content::-webkit-scrollbar {
                width: 6px;
            }

            .drawer-content::-webkit-scrollbar-thumb {
                background: #475569;
                border-radius: 3px;
            }

            .drawer-content::-webkit-scrollbar-track {
                background: rgba(255, 255, 255, 0.05);
            }

        /* å¸§ç¼–è¾‘åŒºåŸŸ */
        .frames-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .frames-title {
            font-size: 16px;
            font-weight: 500;
            color: #cbd5e1;
        }

        /* å¸§åˆ—è¡¨ - æ¨ªå‘æ»šåŠ¨ */
        .frames-container {
            display: flex;
            gap: 16px;
            padding-bottom: 12px;
            overflow-x: auto;
        }

            .frames-container::-webkit-scrollbar {
                height: 6px;
            }

            .frames-container::-webkit-scrollbar-thumb {
                background: #475569;
                border-radius: 3px;
            }

        /* å¸§å¡ç‰‡æ ·å¼ */
        .frame-card {
            min-width: 300px;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 12px;
            padding: 16px;
            border: 2px solid transparent;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

            .frame-card.active {
                border-color: #3b82f6;
                background: rgba(30, 41, 59, 1);
                box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2), 0 4px 12px rgba(0, 0, 0, 0.2);
            }

        .frame-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
        }

        .frame-index {
            font-weight: 600;
            color: #3b82f6;
            font-size: 14px;
        }

        .frame-actions {
            display: flex;
            gap: 8px;
        }

        .frame-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: none;
            background: rgba(255, 255, 255, 0.08);
            color: #e2e8f0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

            .frame-btn:hover {
                background: rgba(255, 255, 255, 0.15);
            }

            .frame-btn.delete {
                background: rgba(239, 68, 68, 0.15);
                color: #ef4444;
            }

                .frame-btn.delete:hover {
                    background: rgba(239, 68, 68, 0.25);
                }

            .frame-btn.preview {
                background: rgba(59, 130, 246, 0.15);
                color: #3b82f6;
            }

                .frame-btn.preview:hover {
                    background: rgba(59, 130, 246, 0.25);
                }

        /* è¡¨å•æ§ä»¶æ ·å¼ */
        .form-group {
            margin-bottom: 14px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            color: #94a3b8;
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: #f1f5f9;
            font-size: 14px;
        }

            .form-input:focus {
                outline: none;
                border-color: #3b82f6;
                box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
            }

        /* é¢œè‰²é€‰æ‹©å™¨ç»„ */
        .color-mode {
            margin-bottom: 14px;
            display: flex;
            gap: 12px;
        }

        .gradient-colors {
            display: flex;
            gap: 10px;
            margin-bottom: 14px;
        }

        .color-input-wrapper {
            flex: 1;
            position: relative;
        }

        .color-input {
            width: 100%;
            height: 40px;
            border: none;
            border-radius: 8px;
            padding: 0;
            cursor: pointer;
            background: transparent;
        }

        .color-label {
            position: absolute;
            top: -20px;
            left: 0;
            font-size: 12px;
            color: #94a3b8;
        }

        .gradient-type {
            display: flex;
            gap: 12px;
            margin-bottom: 14px;
        }

        .radio-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #cbd5e1;
            cursor: pointer;
        }

        .radio-input {
            accent-color: #3b82f6;
        }

        /* æ·»åŠ å¸§æŒ‰é’® */
        .add-frame-btn {
            min-width: 300px;
            height: 100%;
            border: 2px dashed rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            background: rgba(30, 41, 59, 0.3);
            color: #94a3b8;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 16px;
        }

            .add-frame-btn:hover {
                border-color: #3b82f6;
                color: #3b82f6;
                background: rgba(30, 41, 59, 0.5);
            }

        .add-frame-icon {
            font-size: 24px;
        }

        /* é®ç½©å±‚ - æ‰“å¼€æŠ½å±‰æ—¶æ˜¾ç¤º */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
            z-index: 15;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.25s ease;
        }

            .overlay.show {
                opacity: 1;
                pointer-events: auto;
            }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .top-controls {
                flex-wrap: wrap;
                width: 90%;
                gap: 10px;
                padding: 10px 15px;
            }

            .control-btn {
                padding: 8px 12px;
                font-size: 13px;
            }

            .drawer-content {
                padding: 16px;
            }

            .frame-card, .add-frame-btn {
                min-width: 260px;
            }

            .gradient-colors {
                flex-wrap: wrap;
            }

            .color-input-wrapper {
                flex: 1 0 40%;
            }
        }
    </style>
</head>
<body>
    <!-- 3Dåœºæ™¯å®¹å™¨ -->
    <div id="scene-container"></div>

    <!-- é¡¶éƒ¨æ§åˆ¶æ  -->
    <div class="top-controls">
        <button class="control-btn" id="playBtn">
            <span>â–¶ æ’­æ”¾</span>
        </button>
        <button class="control-btn" id="pauseBtn" disabled>
            <span>â¸ æš‚åœ</span>
        </button>
        <button class="control-btn" id="resetBtn">
            <span>â†º é‡ç½®è§†è§’</span>
        </button>
        <div class="speed-control">
            <label>æ’­æ”¾é€Ÿåº¦</label>
            <input type="range" id="playSpeed" min="0.5" max="2" step="0.1" value="1">
        </div>
        <button class="control-btn secondary" id="editBtn">
            <span>âœ ç¼–è¾‘æ–¹æ¡ˆ</span>
        </button>
    </div>

    <!-- çŠ¶æ€æç¤º -->
    <div class="status-hint" id="statusHint">ç¼–è¾‘é¢æ¿å·²æ‰“å¼€</div>

    <!-- é®ç½©å±‚ -->
    <div class="overlay" id="overlay"></div>

    <!-- ç¼–è¾‘æŠ½å±‰é¢æ¿ -->
    <div class="editor-drawer" id="editorDrawer">
        <div class="drawer-header">
            <div class="drawer-title">åŠ¨æ€æ–¹æ¡ˆç¼–è¾‘</div>
            <div class="drawer-actions">
                <button class="drawer-btn control-btn secondary" id="closeEditorBtn">å…³é—­</button>
                <button class="drawer-btn control-btn" id="applyEditorBtn">åº”ç”¨æ–¹æ¡ˆ</button>
            </div>
        </div>
        <div class="drawer-content">
            <div class="frames-header">
                <div class="frames-title">å¸§åºåˆ—ï¼ˆç‚¹å‡»å¸§å¡ç‰‡è¿›è¡Œç¼–è¾‘ï¼‰</div>
            </div>
            <div class="frames-container" id="framesContainer">
                <!-- åˆå§‹å¸§1 -->
                <div class="frame-card active" data-index="0">
                    <div class="frame-header">
                        <div class="frame-index">å¸§ 1</div>
                        <div class="frame-actions">
                            <button class="frame-btn preview" onclick="previewFrame(0)">ğŸ‘</button>
                            <button class="frame-btn delete" onclick="deleteFrame(0)">Ã—</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ–‡å­—å†…å®¹ï¼ˆ1-3ä¸ªå­—ç¬¦ï¼‰</label>
                        <input type="text" class="form-input text-input" value="1" maxlength="3">
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ˜¾ç¤ºæ—¶é•¿ï¼ˆç§’ï¼‰</label>
                        <input type="number" class="form-input duration-input" min="1" max="10" value="2">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ç²’å­å¯†åº¦ï¼ˆè¶Šå°è¶Šå¯†ï¼‰</label>
                        <input type="number" class="form-input density-input" min="5" max="20" value="10">
                    </div>
                    <div class="form-label">é¢œè‰²æ¨¡å¼</div>
                    <div class="color-mode">
                        <label class="radio-label">
                            <input type="radio" class="radio-input color-mode-radio" name="colorMode0" value="single" checked> å•è‰²
                        </label>
                        <label class="radio-label">
                            <input type="radio" class="radio-input color-mode-radio" name="colorMode0" value="gradient"> æ¸å˜
                        </label>
                    </div>
                    <div class="form-label">é¢œè‰²é€‰æ‹©</div>
                    <div class="gradient-colors">
                        <div class="color-input-wrapper">
                            <span class="color-label">ä¸»è‰²</span>
                            <input type="color" class="color-input" value="#3b82f6">
                        </div>
                        <div class="color-input-wrapper" style="display:none">
                            <span class="color-label">é¢œè‰²2</span>
                            <input type="color" class="color-input" value="#8b5cf6">
                        </div>
                        <div class="color-input-wrapper" style="display:none">
                            <span class="color-label">é¢œè‰²3</span>
                            <input type="color" class="color-input" value="#ec4899">
                        </div>
                    </div>
                    <div class="gradient-type" style="display:none">
                        <label class="radio-label">
                            <input type="radio" class="radio-input gradient-type-radio" name="gradientType0" value="linear" checked> çº¿æ€§æ¸å˜
                        </label>
                        <label class="radio-label">
                            <input type="radio" class="radio-input gradient-type-radio" name="gradientType0" value="radial"> å¾„å‘æ¸å˜
                        </label>
                    </div>
                </div>
                <!-- æ·»åŠ å¸§æŒ‰é’® -->
                <button class="add-frame-btn" id="addFrameBtn">
                    <div class="add-frame-icon">+</div>
                    <div>æ·»åŠ æ–°å¸§</div>
                </button>
            </div>
        </div>
    </div>

    <script>
        // 1. Three.jsæ ¸å¿ƒåˆå§‹åŒ–
        const scene = new THREE.Scene();
        const container = document.getElementById('scene-container');
        let width = window.innerWidth;
        let height = window.innerHeight;

        // é€è§†ç›¸æœºï¼ˆå¢å¼ºæ™¯æ·±æ•ˆæœï¼‰
        const camera = new THREE.PerspectiveCamera(70, width / height, 0.1, 2000);
        camera.position.z = 200;

        // WebGLæ¸²æŸ“å™¨ï¼ˆå¼€å¯æŠ—é”¯é½¿ï¼‰
        const renderer = new THREE.WebGLRenderer({
            antialias: true,
            alpha: true
        });
        renderer.setSize(width, height);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // é™åˆ¶é«˜åˆ†è¾¨ç‡æ¸²æŸ“å‹åŠ›
        renderer.setClearColor(0x020617);
        container.appendChild(renderer.domElement);

        // 2. ç²’å­ç³»ç»Ÿæ ¸å¿ƒå˜é‡
        let particleSystem = null; // å½“å‰ç²’å­ç³»ç»Ÿ
        let particleGeometry = null;
        let particleMaterial = null;
        let particles = []; // ç²’å­ä½ç½®å’Œé¢œè‰²æ•°æ®
        let frameData = []; // å­˜å‚¨æ‰€æœ‰å¸§æ•°æ®
        let currentFrameIndex = 0; // å½“å‰æ’­æ”¾å¸§ç´¢å¼•
        let isPlaying = false; // æ’­æ”¾çŠ¶æ€
        let playTimer = null; // æ’­æ”¾è®¡æ—¶å™¨
        let playSpeed = 1; // æ’­æ”¾é€Ÿåº¦
        let animationProgress = 0; // ç²’å­è¿‡æ¸¡åŠ¨ç”»è¿›åº¦
        let targetParticles = []; // ç›®æ ‡ç²’å­çŠ¶æ€ï¼ˆç”¨äºè¿‡æ¸¡åŠ¨ç”»ï¼‰
        let rotationX = 0, rotationY = 0; // æ—‹è½¬è§’åº¦
        let isDragging = false;
        let lastX, lastY;
        let isEditorOpen = false; // ç¼–è¾‘é¢æ¿çŠ¶æ€

        // 3. åˆå§‹åŒ–å¸§æ•°æ®
        function initFrameData() {
            const frameCards = document.querySelectorAll('.frame-card');
            frameCards.forEach((card, index) => {
                frameData.push(getFrameDataFromCard(card, index));

                // ä¸ºé¢œè‰²æ¨¡å¼æ·»åŠ äº‹ä»¶ç›‘å¬
                setupColorModeListeners(card, index);
            });
            // åˆå§‹æ¸²æŸ“ç¬¬ä¸€å¸§
            renderFrame(0);
        }

        // è®¾ç½®é¢œè‰²æ¨¡å¼åˆ‡æ¢ç›‘å¬
        function setupColorModeListeners(card, index) {
            const radioInputs = card.querySelectorAll('.color-mode-radio');
            const colorInputs = card.querySelectorAll('.color-input-wrapper');
            const gradientType = card.querySelector('.gradient-type');

            // æ˜¾ç¤º/éšè—ç›¸å…³æ§ä»¶
            function updateColorControls() {
                const isGradient = card.querySelector('.color-mode-radio[value="gradient"]').checked;

                // æ˜¾ç¤ºç¬¬ä¸€ä¸ªé¢œè‰²é€‰æ‹©å™¨ï¼Œæ ¹æ®æ¨¡å¼æ˜¾ç¤ºå…¶ä»–
                for (let i = 0; i < colorInputs.length; i++) {
                    colorInputs[i].style.display = i === 0 || isGradient ? 'block' : 'none';
                }

                gradientType.style.display = isGradient ? 'flex' : 'none';
            }

            // åˆå§‹æ›´æ–°
            updateColorControls();

            // æ·»åŠ äº‹ä»¶ç›‘å¬
            radioInputs.forEach(input => {
                input.addEventListener('change', () => {
                    updateColorControls();
                    if (index === currentFrameIndex) {
                        frameData[index] = getFrameDataFromCard(card, index);
                    }
                });
            });
        }

        // ä»å¸§å¡ç‰‡è·å–æ•°æ®
        function getFrameDataFromCard(card, index) {
            const text = card.querySelector('.text-input').value.trim() || `${index + 1}`;
            const duration = parseFloat(card.querySelector('.duration-input').value) || 2;
            const density = parseInt(card.querySelector('.density-input').value) || 10;
            const colorMode = card.querySelector('.color-mode-radio:checked').value;
            const colors = Array.from(card.querySelectorAll('.color-input')).map(input => input.value);
            const gradientType = colorMode === 'gradient' ?
                card.querySelector('.gradient-type-radio:checked').value : 'linear';

            return {
                text,
                duration,
                density,
                colorMode,
                colors,
                gradientType
            };
        }

        // 4. æ–‡å­—è½¬3Dç²’å­ï¼ˆæ ¸å¿ƒæ¸²æŸ“å‡½æ•°ï¼‰
        function textToParticles(text, density, colorMode, colors, gradientType, isTarget = false) {
            // åˆ›å»ºä¸´æ—¶Canvasç”Ÿæˆæ–‡å­—åƒç´ 
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 400;
            canvas.height = 200;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // è®¾ç½®æ–‡å­—æ ·å¼
            const fontSize = 120;
            ctx.font = `bold ${fontSize}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillStyle = '#fff';
            ctx.fillText(text, canvas.width / 2, canvas.height / 2);

            // è·å–åƒç´ æ•°æ®
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height).data;

            // å¤„ç†é¢œè‰²
            const colorValues = colors.map(color => new THREE.Color(color));

            // ç”Ÿæˆç²’å­æ•°æ®
            const particleData = [];
            for (let y = 0; y < canvas.height; y += density) {
                for (let x = 0; x < canvas.width; x += density) {
                    const index = (y * canvas.width + x) * 4;
                    const alpha = imageData[index + 3];

                    if (alpha > 100) {
                        // è®¡ç®—3Dåæ ‡
                        const posX = (x - canvas.width / 2) / 3;
                        const posY = (canvas.height / 2 - y) / 3;
                        const posZ = (Math.random() - 0.5) * 20; // Zè½´éšæœºåç§»å¢åŠ 3Dæ„Ÿ

                        // ç¡®å®šç²’å­é¢œè‰²
                        let color;
                        if (colorMode === 'single') {
                            // å•è‰²æ¨¡å¼
                            color = colorValues[0].clone();
                        } else {
                            // æ¸å˜æ¨¡å¼
                            if (gradientType === 'linear') {
                                // çº¿æ€§æ¸å˜ï¼ˆåŸºäºXåæ ‡ï¼‰
                                const ratio = (x / canvas.width) * (colorValues.length - 1);
                                const colorIndex = Math.floor(ratio);
                                const blend = ratio - colorIndex;
                                if (colorIndex < colorValues.length - 1) {
                                    color = colorValues[colorIndex].clone().lerp(colorValues[colorIndex + 1], blend);
                                } else {
                                    color = colorValues[colorValues.length - 1].clone();
                                }
                            } else {
                                // å¾„å‘æ¸å˜ï¼ˆåŸºäºä¸­å¿ƒè·ç¦»ï¼‰
                                const centerX = canvas.width / 2;
                                const centerY = canvas.height / 2;
                                const distance = Math.sqrt(Math.pow(x - centerX, 2) + Math.pow(y - centerY, 2));
                                const maxDistance = Math.sqrt(Math.pow(centerX, 2) + Math.pow(centerY, 2));
                                const ratio = (distance / maxDistance) * (colorValues.length - 1);
                                const colorIndex = Math.floor(ratio);
                                const blend = ratio - colorIndex;
                                if (colorIndex < colorValues.length - 1) {
                                    color = colorValues[colorIndex].clone().lerp(colorValues[colorIndex + 1], blend);
                                } else {
                                    color = colorValues[colorValues.length - 1].clone();
                                }
                            }
                        }

                        // æ·»åŠ ç²’å­å¤§å°éšæœºå˜åŒ–ï¼Œå¢å¼ºçœŸå®æ„Ÿ
                        const size = 1.5 + Math.random() * 1.5;

                        particleData.push({
                            position: new THREE.Vector3(posX, posY, posZ),
                            color: color,
                            size: size
                        });
                    }
                }
            }

            // å¦‚æœæ˜¯ç›®æ ‡ç²’å­çŠ¶æ€ï¼Œå­˜å‚¨èµ·æ¥ç”¨äºè¿‡æ¸¡åŠ¨ç”»
            if (isTarget) {
                targetParticles = particleData;
                animationProgress = 0;
            } else {
                particles = particleData;
                updateParticleSystem();
            }
        }

        // æ›´æ–°ç²’å­ç³»ç»Ÿ - ä¿®å¤äº†Shaderé”™è¯¯
        function updateParticleSystem() {
            // æ¸…é™¤æ—§ç²’å­ç³»ç»Ÿ
            if (particleSystem) {
                scene.remove(particleSystem);
                if (particleGeometry) particleGeometry.dispose();
                if (particleMaterial) particleMaterial.dispose();
            }

            // åˆ›å»ºæ–°çš„ç²’å­å‡ ä½•
            particleGeometry = new THREE.BufferGeometry();
            const positions = [];
            const colors = [];
            const sizes = [];

            // å¡«å……ç²’å­æ•°æ®
            particles.forEach(particle => {
                positions.push(particle.position.x, particle.position.y, particle.position.z);
                colors.push(particle.color.r, particle.color.g, particle.color.b);
                sizes.push(particle.size);
            });

            particleGeometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            particleGeometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            particleGeometry.setAttribute('size', new THREE.Float32BufferAttribute(sizes, 1));

            // åˆ›å»ºç²’å­æè´¨ï¼ˆå¸¦å‘å…‰æ•ˆæœï¼‰
            particleMaterial = new THREE.ShaderMaterial({
                uniforms: {
                    pointTexture: { value: new THREE.TextureLoader().load('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==') }
                },
                vertexShader: `
                            attribute float size;
                            attribute vec3 color;
                            varying vec3 vColor;
                            void main() {
                                vColor = color;
                                vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
                                gl_PointSize = size * (200.0 / -mvPosition.z);
                                gl_Position = projectionMatrix * mvPosition;
                            }
                        `,
                fragmentShader: `
                            varying vec3 vColor;
                            uniform sampler2D pointTexture;
                            void main() {
                                gl_FragColor = vec4(vColor, 0.9);
                                gl_FragColor = gl_FragColor * texture2D(pointTexture, gl_PointCoord);
                            }
                        `,
                transparent: true,
                blending: THREE.AdditiveBlending,
                depthWrite: false
            });

            // åˆ›å»ºç‚¹ç³»ç»Ÿå¹¶æ·»åŠ åˆ°åœºæ™¯
            particleSystem = new THREE.Points(particleGeometry, particleMaterial);
            particleSystem.rotation.x = rotationX;
            particleSystem.rotation.y = rotationY;
            scene.add(particleSystem);
        }

        // 5. æ¸²æŸ“æŒ‡å®šå¸§
        function renderFrame(index) {
            if (!frameData[index]) return;

            const frame = frameData[index];
            // ç”Ÿæˆç›®æ ‡ç²’å­çŠ¶æ€
            textToParticles(
                frame.text,
                frame.density,
                frame.colorMode,
                frame.colors,
                frame.gradientType,
                true
            );

            // å¦‚æœæ˜¯ç¬¬ä¸€å¸§ï¼Œç›´æ¥æ˜¾ç¤º
            if (particles.length === 0) {
                particles = [...targetParticles];
                updateParticleSystem();
            }

            currentFrameIndex = index;
            updateActiveFrameCard();
        }

        // é¢„è§ˆå½“å‰å¸§
        function previewFrame(index) {
            if (!frameData[index]) return;

            // æ›´æ–°å¸§æ•°æ®
            const frameCard = document.querySelector(`.frame-card[data-index="${index}"]`);
            if (frameCard) {
                frameData[index] = getFrameDataFromCard(frameCard, index);
            }

            // æ¸²æŸ“è¯¥å¸§
            renderFrame(index);

            // æ˜¾ç¤ºæç¤º
            showStatusHint(`å·²é¢„è§ˆ å¸§ ${index + 1}`);
        }

        // 6. å¸§è¿‡æ¸¡åŠ¨ç”»
        function animateFrameTransition() {
            if (animationProgress >= 1) {
                particles = [...targetParticles];
                updateParticleSystem();
                return false;
            }

            // è®¡ç®—è¿‡æ¸¡åŠ¨ç”»è¿›åº¦
            animationProgress += 0.02;
            if (animationProgress > 1) animationProgress = 1;

            // ç²’å­è¿‡æ¸¡åŠ¨ç”»ï¼ˆä½ç½®ã€é¢œè‰²ã€å¤§å°ï¼‰
            const easedProgress = 1 - Math.pow(1 - animationProgress, 3); // ç¼“åŠ¨å‡½æ•°ï¼Œä½¿åŠ¨ç”»æ›´è‡ªç„¶

            // ç¡®ä¿ç²’å­æ•°é‡ä¸€è‡´ï¼ˆå–æœ€å¤§å€¼ï¼‰
            const maxParticles = Math.max(particles.length, targetParticles.length);
            const newParticles = [];

            for (let i = 0; i < maxParticles; i++) {
                const oldParticle = particles[i] || {
                    position: new THREE.Vector3(0, 0, 0),
                    color: new THREE.Color(0, 0, 0),
                    size: 0
                };
                const newParticle = targetParticles[i] || {
                    position: new THREE.Vector3(0, 0, 0),
                    color: new THREE.Color(0, 0, 0),
                    size: 0
                };

                // æ’å€¼è®¡ç®—ä¸­é—´çŠ¶æ€
                const position = oldParticle.position.clone().lerp(newParticle.position, easedProgress);
                const color = oldParticle.color.clone().lerp(newParticle.color, easedProgress);
                const size = oldParticle.size + (newParticle.size - oldParticle.size) * easedProgress;

                newParticles.push({ position, color, size });
            }

            particles = newParticles;
            updateParticleSystem();
            return true;
        }

        // 7. æ’­æ”¾æ§åˆ¶
        function startPlayback() {
            if (isPlaying || frameData.length <= 1) {
                if (frameData.length <= 1) {
                    showStatusHint("è‡³å°‘éœ€è¦2ä¸ªå¸§æ‰èƒ½æ’­æ”¾åŠ¨ç”»");
                }
                return;
            }

            isPlaying = true;
            document.getElementById('playBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = false;

            // å¦‚æœç¼–è¾‘é¢æ¿æ‰“å¼€åˆ™å…³é—­
            if (isEditorOpen) {
                toggleEditor(false);
            }

            playNextFrame();
        }

        function pausePlayback() {
            if (!isPlaying) return;

            isPlaying = false;
            if (playTimer) {
                clearTimeout(playTimer);
                playTimer = null;
            }
            document.getElementById('playBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
        }

        function playNextFrame() {
            if (!isPlaying) return;

            // è®¡ç®—ä¸‹ä¸€å¸§ç´¢å¼•
            const nextIndex = (currentFrameIndex + 1) % frameData.length;

            // è·å–å½“å‰å¸§çš„æ˜¾ç¤ºæ—¶é•¿
            const currentFrame = frameData[currentFrameIndex];
            const delay = currentFrame.duration * 1000 / playSpeed;

            // è®¾ç½®è®¡æ—¶å™¨ï¼Œå»¶è¿Ÿååˆ‡æ¢åˆ°ä¸‹ä¸€å¸§
            playTimer = setTimeout(() => {
                renderFrame(nextIndex);
                playNextFrame();
            }, delay);
        }

        // 8. äº¤äº’æ§åˆ¶ï¼ˆé¼ æ ‡æ‹–æ‹½æ—‹è½¬ï¼‰
        function initInteraction() {
            container.addEventListener('pointerdown', (e) => {
                if (isEditorOpen) return; // ç¼–è¾‘é¢æ¿æ‰“å¼€æ—¶ä¸å“åº”æ‹–æ‹½
                isDragging = true;
                lastX = e.clientX;
                lastY = e.clientY;
            });

            container.addEventListener('pointermove', (e) => {
                if (!isDragging || !particleSystem || isEditorOpen) return;

                const deltaX = e.clientX - lastX;
                const deltaY = e.clientY - lastY;

                // æ§åˆ¶æ—‹è½¬é€Ÿåº¦
                rotationY += deltaX * 0.005;
                rotationX -= deltaY * 0.005;
                rotationX = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, rotationX)); // é™åˆ¶ä¸Šä¸‹æ—‹è½¬

                // æ›´æ–°ç²’å­æ—‹è½¬
                particleSystem.rotation.x = rotationX;
                particleSystem.rotation.y = rotationY;

                lastX = e.clientX;
                lastY = e.clientY;
            });

            container.addEventListener('pointerup', () => isDragging = false);
            container.addEventListener('pointerleave', () => isDragging = false);

            // é‡ç½®è§†è§’
            document.getElementById('resetBtn').addEventListener('click', () => {
                rotationX = 0;
                rotationY = 0;
                if (particleSystem) {
                    particleSystem.rotation.x = rotationX;
                    particleSystem.rotation.y = rotationY;
                }
                showStatusHint("è§†è§’å·²é‡ç½®");
            });

            // æ’­æ”¾/æš‚åœæ§åˆ¶
            document.getElementById('playBtn').addEventListener('click', startPlayback);
            document.getElementById('pauseBtn').addEventListener('click', pausePlayback);

            // æ’­æ”¾é€Ÿåº¦æ§åˆ¶
            document.getElementById('playSpeed').addEventListener('input', (e) => {
                playSpeed = parseFloat(e.target.value);
                showStatusHint(`æ’­æ”¾é€Ÿåº¦: ${playSpeed}x`);
                if (isPlaying) {
                    pausePlayback();
                    startPlayback();
                }
            });

            // ç¼–è¾‘é¢æ¿æ§åˆ¶
            document.getElementById('editBtn').addEventListener('click', () => {
                toggleEditor(true);
            });

            document.getElementById('closeEditorBtn').addEventListener('click', () => {
                toggleEditor(false);
            });

            document.getElementById('applyEditorBtn').addEventListener('click', () => {
                // ä¿å­˜æ‰€æœ‰å¸§æ•°æ®
                saveAllFrameData();
                // å…³é—­ç¼–è¾‘é¢æ¿
                toggleEditor(false);
                // é‡æ–°æ¸²æŸ“å½“å‰å¸§
                renderFrame(currentFrameIndex);
                showStatusHint("æ–¹æ¡ˆå·²æ›´æ–°");
            });

            // ç‚¹å‡»é®ç½©å±‚å…³é—­ç¼–è¾‘é¢æ¿
            document.getElementById('overlay').addEventListener('click', () => {
                toggleEditor(false);
            });

            // æ·»åŠ æ–°å¸§
            document.getElementById('addFrameBtn').addEventListener('click', addNewFrame);
        }

        // åˆ‡æ¢ç¼–è¾‘é¢æ¿æ˜¾ç¤ºçŠ¶æ€
        function toggleEditor(show) {
            const drawer = document.getElementById('editorDrawer');
            const overlay = document.getElementById('overlay');
            const statusHint = document.getElementById('statusHint');

            if (show) {
                drawer.classList.add('open');
                overlay.classList.add('show');
                statusHint.textContent = "ç¼–è¾‘å¸§åºåˆ—ï¼Œå®Œæˆåç‚¹å‡»åº”ç”¨æ–¹æ¡ˆ";
                statusHint.classList.add('show');
                isEditorOpen = true;

                // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œæš‚åœ
                if (isPlaying) {
                    pausePlayback();
                }
            } else {
                drawer.classList.remove('open');
                overlay.classList.remove('show');
                statusHint.classList.remove('show');
                isEditorOpen = false;
            }
        }

        // ä¿å­˜æ‰€æœ‰å¸§æ•°æ®
        function saveAllFrameData() {
            const frameCards = document.querySelectorAll('.frame-card');
            frameData = [];
            frameCards.forEach((card, index) => {
                frameData.push(getFrameDataFromCard(card, index));
            });
        }

        // æ˜¾ç¤ºçŠ¶æ€æç¤º
        function showStatusHint(text) {
            const statusHint = document.getElementById('statusHint');
            statusHint.textContent = text;
            statusHint.classList.add('show');

            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                statusHint.classList.remove('show');
            }, 3000);
        }

        // 9. å¸§ç®¡ç†åŠŸèƒ½
        function addNewFrame() {
            const framesContainer = document.getElementById('framesContainer');
            const newIndex = frameData.length;

            // åˆ›å»ºæ–°å¸§å¡ç‰‡
            const newFrameCard = document.createElement('div');
            newFrameCard.className = 'frame-card';
            newFrameCard.dataset.index = newIndex;
            newFrameCard.innerHTML = `
                        <div class="frame-header">
                            <div class="frame-index">å¸§ ${newIndex + 1}</div>
                            <div class="frame-actions">
                                <button class="frame-btn preview" onclick="previewFrame(${newIndex})">ğŸ‘</button>
                                <button class="frame-btn delete" onclick="deleteFrame(${newIndex})">Ã—</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ–‡å­—å†…å®¹ï¼ˆ1-3ä¸ªå­—ç¬¦ï¼‰</label>
                            <input type="text" class="form-input text-input" value="${newIndex + 1}" maxlength="3">
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ˜¾ç¤ºæ—¶é•¿ï¼ˆç§’ï¼‰</label>
                            <input type="number" class="form-input duration-input" min="1" max="10" value="2">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ç²’å­å¯†åº¦ï¼ˆè¶Šå°è¶Šå¯†ï¼‰</label>
                            <input type="number" class="form-input density-input" min="5" max="20" value="10">
                        </div>
                        <div class="form-label">é¢œè‰²æ¨¡å¼</div>
                        <div class="color-mode">
                            <label class="radio-label">
                                <input type="radio" class="radio-input color-mode-radio" name="colorMode${newIndex}" value="single" checked> å•è‰²
                            </label>
                            <label class="radio-label">
                                <input type="radio" class="radio-input color-mode-radio" name="colorMode${newIndex}" value="gradient"> æ¸å˜
                            </label>
                        </div>
                        <div class="form-label">é¢œè‰²é€‰æ‹©</div>
                        <div class="gradient-colors">
                            <div class="color-input-wrapper">
                                <span class="color-label">ä¸»è‰²</span>
                                <input type="color" class="color-input" value="#3b82f6">
                            </div>
                            <div class="color-input-wrapper" style="display:none">
                                <span class="color-label">é¢œè‰²2</span>
                                <input type="color" class="color-input" value="#8b5cf6">
                            </div>
                            <div class="color-input-wrapper" style="display:none">
                                <span class="color-label">é¢œè‰²3</span>
                                <input type="color" class="color-input" value="#ec4899">
                            </div>
                        </div>
                        <div class="gradient-type" style="display:none">
                            <label class="radio-label">
                                <input type="radio" class="radio-input gradient-type-radio" name="gradientType${newIndex}" value="linear" checked> çº¿æ€§æ¸å˜
                            </label>
                            <label class="radio-label">
                                <input type="radio" class="radio-input gradient-type-radio" name="gradientType${newIndex}" value="radial"> å¾„å‘æ¸å˜
                            </label>
                        </div>
                    `;

            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            newFrameCard.addEventListener('click', (e) => {
                if (!e.target.closest('.frame-btn')) {
                    selectFrame(newIndex);
                }
            });

            // æ·»åŠ è¾“å…¥å˜åŒ–äº‹ä»¶
            const inputs = newFrameCard.querySelectorAll('input:not(.color-mode-radio)');
            inputs.forEach(input => {
                input.addEventListener('input', () => {
                    if (newIndex === currentFrameIndex) {
                        frameData[newIndex] = getFrameDataFromCard(newFrameCard, newIndex);
                    }
                });
            });

            // è®¾ç½®é¢œè‰²æ¨¡å¼ç›‘å¬
            setupColorModeListeners(newFrameCard, newIndex);

            // æ’å…¥åˆ°å®¹å™¨ä¸­ï¼ˆæ·»åŠ å¸§æŒ‰é’®å‰ï¼‰
            framesContainer.insertBefore(newFrameCard, document.getElementById('addFrameBtn'));

            // æ›´æ–°å¸§æ•°æ®
            frameData.push(getFrameDataFromCard(newFrameCard, newIndex));

            // é€‰ä¸­æ–°å¸§
            selectFrame(newIndex);

            showStatusHint(`å·²æ·»åŠ  å¸§ ${newIndex + 1}`);
        }

        function deleteFrame(index) {
            if (frameData.length <= 1) {
                showStatusHint("è‡³å°‘ä¿ç•™1ä¸ªå¸§");
                return;
            }

            // ç§»é™¤å¸§å¡ç‰‡
            const frameCard = document.querySelector(`.frame-card[data-index="${index}"]`);
            if (frameCard) frameCard.remove();

            // æ›´æ–°å¸§æ•°æ®
            frameData.splice(index, 1);

            // æ›´æ–°å‰©ä½™å¸§çš„ç´¢å¼•å’Œäº‹ä»¶
            const remainingFrames = document.querySelectorAll('.frame-card');
            remainingFrames.forEach((card, i) => {
                card.dataset.index = i;
                card.querySelector('.frame-index').textContent = `å¸§ ${i + 1}`;
                card.querySelector('.preview').setAttribute('onclick', `previewFrame(${i})`);
                card.querySelector('.delete').setAttribute('onclick', `deleteFrame(${i})`);

                // æ›´æ–°å•é€‰æŒ‰é’®åç§°ï¼ˆé¿å…å†²çªï¼‰
                const colorModeRadios = card.querySelectorAll('.color-mode-radio');
                colorModeRadios.forEach(radio => {
                    radio.name = `colorMode${i}`;
                });

                const gradientRadios = card.querySelectorAll('.gradient-type-radio');
                gradientRadios.forEach(radio => {
                    radio.name = `gradientType${i}`;
                });

                // é‡æ–°è®¾ç½®äº‹ä»¶ç›‘å¬
                setupColorModeListeners(card, i);
            });

            // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰å¸§ï¼Œåˆ‡æ¢åˆ°ç¬¬ä¸€å¸§
            if (index === currentFrameIndex) {
                const newIndex = Math.min(index, frameData.length - 1);
                selectFrame(newIndex);
                renderFrame(newIndex);
            } else if (index < currentFrameIndex) {
                // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰å¸§å‰é¢çš„å¸§ï¼Œæ›´æ–°å½“å‰ç´¢å¼•
                currentFrameIndex--;
                updateActiveFrameCard();
            }

            showStatusHint(`å·²åˆ é™¤ å¸§ ${index + 1}`);
        }

        function selectFrame(index) {
            // æ›´æ–°å½“å‰å¸§ç´¢å¼•
            currentFrameIndex = index;
            updateActiveFrameCard();
        }

        function updateActiveFrameCard() {
            // ç§»é™¤æ‰€æœ‰å¸§çš„activeç±»
            document.querySelectorAll('.frame-card').forEach(card => {
                card.classList.remove('active');
            });

            // ç»™å½“å‰å¸§æ·»åŠ activeç±»
            const activeCard = document.querySelector(`.frame-card[data-index="${currentFrameIndex}"]`);
            if (activeCard) activeCard.classList.add('active');
        }

        // 10. çª—å£å¤§å°é€‚é…
        function onWindowResize() {
            width = window.innerWidth;
            height = window.innerHeight;
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
            renderer.setSize(width, height);
        }

        window.addEventListener('resize', onWindowResize);

        // 11. åŠ¨ç”»å¾ªç¯
        function animate() {
            requestAnimationFrame(animate);

            // å¦‚æœæ­£åœ¨è¿‡æ¸¡åŠ¨ç”»ï¼Œæ›´æ–°ç²’å­çŠ¶æ€
            if (animationProgress < 1 && targetParticles.length > 0) {
                animateFrameTransition();
            }

            // è½»å¾®çš„ç²’å­é—ªçƒæ•ˆæœï¼Œå¢å¼ºçœŸå®æ„Ÿ
            if (particleSystem && particleMaterial && particleMaterial.uniforms) {
                const flicker = 0.95 + Math.sin(Date.now() * 0.003) * 0.05;
                particleMaterial.opacity = flicker;
            }

            renderer.render(scene, camera);
        }

        // åˆå§‹åŒ–
        window.addEventListener('load', () => {
            initFrameData();
            initInteraction();
            animate();
        });
    </script>
</body>
</html>