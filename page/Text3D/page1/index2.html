<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3Dç²’å­æ— äººæœºè¡¨æ¼”æ¨¡æ‹Ÿå™¨--V2</title>
    <!-- å¼•å…¥Three.jsåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Inter', 'Arial', sans-serif;
            transition: all 0.25s ease;
        }

        body {
            background: #020617; /* æ·±ç©ºé»‘èƒŒæ™¯ */
            min-height: 100vh;
            color: #e2e8f0;
            overflow-x: hidden;
            position: relative;
        }

        /* 3Dåœºæ™¯å®¹å™¨ - å…¨å±æ˜¾ç¤º */
        #scene-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            cursor: grab;
            z-index: 1;
        }

            #scene-container:active {
                cursor: grabbing;
            }

        /* é¡¶éƒ¨æ§åˆ¶æ  - æ‚¬æµ®å±…ä¸­ */
        .top-controls {
            position: fixed;
            top: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(16px);
            border-radius: 16px;
            padding: 12px 24px;
            display: flex;
            gap: 18px;
            align-items: center;
            z-index: 10;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .control-btn {
            padding: 10px 18px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            background: #3b82f6;
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

            .control-btn:hover {
                background: #2563eb;
                transform: translateY(-2px);
                box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
            }

            .control-btn:disabled {
                background: #475569;
                color: #94a3b8;
                cursor: not-allowed;
                transform: none;
                box-shadow: none;
            }

            .control-btn.secondary {
                background: rgba(255, 255, 255, 0.1);
                color: #e2e8f0;
                box-shadow: none;
            }

                .control-btn.secondary:hover {
                    background: rgba(255, 255, 255, 0.15);
                    box-shadow: none;
                }

        /* æ’­æ”¾é€Ÿåº¦æ§åˆ¶ */
        .speed-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

            .speed-control label {
                font-size: 14px;
                color: #cbd5e1;
                white-space: nowrap;
            }

            .speed-control input {
                width: 120px;
                accent-color: #3b82f6;
            }

        /* çŠ¶æ€æç¤º */
        .status-hint {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(8px);
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            color: #94a3b8;
            z-index: 10;
            border: 1px solid rgba(255, 255, 255, 0.05);
            opacity: 0;
            pointer-events: none;
        }

            .status-hint.show {
                opacity: 1;
                pointer-events: auto;
            }

        /* ç¼–è¾‘é¢æ¿ - åº•éƒ¨æŠ½å±‰å¼å¼¹çª— */
        .editor-drawer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100vw;
            max-height: 90vh;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(16px);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.4);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 20;
            transform: translateY(100%); /* é»˜è®¤éšè— */
            overflow: hidden;
        }

            .editor-drawer.open {
                transform: translateY(0); /* æ‰“å¼€æ—¶æ»‘å…¥ */
            }

        /* æŠ½å±‰å¤´éƒ¨ */
        .drawer-header {
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .drawer-title {
            font-size: 18px;
            font-weight: 600;
            color: #f1f5f9;
        }

        .drawer-actions {
            display: flex;
            gap: 12px;
        }

        .drawer-btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            cursor: pointer;
        }

        /* æŠ½å±‰å†…å®¹åŒº */
        .drawer-content {
            padding: 24px;
            overflow-y: auto;
            max-height: calc(90vh - 70px);
        }

            .drawer-content::-webkit-scrollbar {
                width: 6px;
            }

            .drawer-content::-webkit-scrollbar-thumb {
                background: #475569;
                border-radius: 3px;
            }

            .drawer-content::-webkit-scrollbar-track {
                background: rgba(255, 255, 255, 0.05);
            }

        /* å¸§ç¼–è¾‘åŒºåŸŸ */
        .frames-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .frames-title {
            font-size: 16px;
            font-weight: 500;
            color: #cbd5e1;
        }

        /* å¸§åˆ—è¡¨ - æ¨ªå‘æ»šåŠ¨ */
        .frames-container {
            display: flex;
            gap: 16px;
            padding-bottom: 12px;
            overflow-x: auto;
        }

            .frames-container::-webkit-scrollbar {
                height: 6px;
            }

            .frames-container::-webkit-scrollbar-thumb {
                background: #475569;
                border-radius: 3px;
            }

        /* å¸§å¡ç‰‡æ ·å¼ */
        .frame-card {
            min-width: 300px;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 12px;
            padding: 16px;
            border: 2px solid transparent;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

            .frame-card.active {
                border-color: #3b82f6;
                background: rgba(30, 41, 59, 1);
                box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2), 0 4px 12px rgba(0, 0, 0, 0.2);
            }

        .frame-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
        }

        .frame-index {
            font-weight: 600;
            color: #3b82f6;
            font-size: 14px;
        }

        .frame-actions {
            display: flex;
            gap: 8px;
        }

        .frame-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: none;
            background: rgba(255, 255, 255, 0.08);
            color: #e2e8f0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

            .frame-btn:hover {
                background: rgba(255, 255, 255, 0.15);
            }

            .frame-btn.delete {
                background: rgba(239, 68, 68, 0.15);
                color: #ef4444;
            }

                .frame-btn.delete:hover {
                    background: rgba(239, 68, 68, 0.25);
                }

            .frame-btn.preview {
                background: rgba(59, 130, 246, 0.15);
                color: #3b82f6;
            }

                .frame-btn.preview:hover {
                    background: rgba(59, 130, 246, 0.25);
                }

        /* è¡¨å•æ§ä»¶æ ·å¼ */
        .form-group {
            margin-bottom: 14px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            color: #94a3b8;
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: #f1f5f9;
            font-size: 14px;
        }

            .form-input:focus {
                outline: none;
                border-color: #3b82f6;
                box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
            }

        /* å¤šè¡Œæ–‡æœ¬æ¡†æ ·å¼ */
        .text-input {
            min-height: 80px;
            resize: vertical;
            white-space: pre-wrap;
            font-family: Arial, sans-serif;
        }

        /* è¡Œé—´è·æ§åˆ¶ */
        .line-spacing-control {
            margin-bottom: 14px;
        }

        /* ä½ç½®æ§åˆ¶æ»‘å—ç»„ */
        .position-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 14px;
        }

        .position-control {
            flex: 1;
        }

            .position-control input {
                width: 100%;
            }

        /* é¢œè‰²é€‰æ‹©å™¨ç»„ */
        .color-mode {
            margin-bottom: 14px;
            display: flex;
            gap: 12px;
        }

        .gradient-colors {
            display: flex;
            gap: 10px;
            margin-bottom: 14px;
        }

        .color-input-wrapper {
            flex: 1;
            position: relative;
        }

        .color-input {
            width: 100%;
            height: 40px;
            border: none;
            border-radius: 8px;
            padding: 0;
            cursor: pointer;
            background: transparent;
        }

        .color-label {
            position: absolute;
            top: -20px;
            left: 0;
            font-size: 12px;
            color: #94a3b8;
        }

        .gradient-type {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 14px;
        }

        .radio-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #cbd5e1;
            cursor: pointer;
        }

        .radio-input {
            accent-color: #3b82f6;
        }

        /* ç‰¹æ•ˆæ§åˆ¶åŒº */
        .effects-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        .effects-title {
            font-size: 14px;
            font-weight: 500;
            color: #cbd5e1;
            margin-bottom: 12px;
        }

        /* Zè½´æ¨¡å¼æ§åˆ¶ */
        .z-axis-mode {
            margin-bottom: 14px;
            display: flex;
            gap: 12px;
        }

        /* æ—¶é—´æ§åˆ¶åŒºåŸŸ */
        .timing-controls {
            margin-bottom: 14px;
            display: flex;
            gap: 10px;
        }

        .timing-control {
            flex: 1;
        }

        /* è¿‡æ¸¡æ§åˆ¶åŒºåŸŸ */
        .transition-control {
            margin-bottom: 14px;
        }

        /* æ·»åŠ å¸§æŒ‰é’® */
        .add-frame-btn {
            min-width: 300px;
            height: 100%;
            border: 2px dashed rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            background: rgba(30, 41, 59, 0.3);
            color: #94a3b8;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 16px;
        }

            .add-frame-btn:hover {
                border-color: #3b82f6;
                color: #3b82f6;
                background: rgba(30, 41, 59, 0.5);
            }

        .add-frame-icon {
            font-size: 24px;
        }

        /* é®ç½©å±‚ - æ‰“å¼€æŠ½å±‰æ—¶æ˜¾ç¤º */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
            z-index: 15;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.25s ease;
        }

            .overlay.show {
                opacity: 1;
                pointer-events: auto;
            }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .top-controls {
                flex-wrap: wrap;
                width: 90%;
                gap: 10px;
                padding: 10px 15px;
            }

            .control-btn {
                padding: 8px 12px;
                font-size: 13px;
            }

            .drawer-content {
                padding: 16px;
            }

            .frame-card, .add-frame-btn {
                min-width: 260px;
            }

            .gradient-colors, .position-controls, .timing-controls {
                flex-wrap: wrap;
            }

            .color-input-wrapper, .position-control, .timing-control {
                flex: 1 0 40%;
            }
        }
    </style>
</head>
<body>
    <!-- 3Dåœºæ™¯å®¹å™¨ -->
    <div id="scene-container"></div>

    <!-- é¡¶éƒ¨æ§åˆ¶æ  -->
    <div class="top-controls">
        <button class="control-btn" id="playBtn">
            <span>â–¶ æ’­æ”¾</span>
        </button>
        <button class="control-btn" id="pauseBtn" disabled>
            <span>â¸ æš‚åœ</span>
        </button>
        <button class="control-btn" id="resetBtn">
            <span>â†º é‡ç½®è§†è§’</span>
        </button>
        <div class="speed-control">
            <label>æ’­æ”¾é€Ÿåº¦</label>
            <input type="range" id="playSpeed" min="0.5" max="2" step="0.1" value="1">
        </div>
        <button class="control-btn secondary" id="editBtn">
            <span>âœ ç¼–è¾‘æ–¹æ¡ˆ</span>
        </button>
    </div>

    <!-- çŠ¶æ€æç¤º -->
    <div class="status-hint" id="statusHint">ç¼–è¾‘é¢æ¿å·²æ‰“å¼€</div>

    <!-- é®ç½©å±‚ -->
    <div class="overlay" id="overlay"></div>

    <!-- ç¼–è¾‘æŠ½å±‰é¢æ¿ -->
    <div class="editor-drawer" id="editorDrawer">
        <div class="drawer-header">
            <div class="drawer-title">åŠ¨æ€æ–¹æ¡ˆç¼–è¾‘</div>
            <div class="drawer-actions">
                <button class="drawer-btn control-btn secondary" id="closeEditorBtn">å…³é—­</button>
                <button class="drawer-btn control-btn" id="applyEditorBtn">åº”ç”¨æ–¹æ¡ˆ</button>
            </div>
        </div>
        <div class="drawer-content">
            <div class="frames-header">
                <div class="frames-title">å¸§åºåˆ—ï¼ˆç‚¹å‡»å¸§å¡ç‰‡è¿›è¡Œç¼–è¾‘ï¼‰</div>
            </div>
            <div class="frames-container" id="framesContainer">
                <!-- åˆå§‹å¸§1 -->
                <div class="frame-card active" data-index="0">
                    <div class="frame-header">
                        <div class="frame-index">å¸§ 1</div>
                        <div class="frame-actions">
                            <button class="frame-btn preview" onclick="previewFrame(0)">ğŸ‘</button>
                            <button class="frame-btn delete" onclick="deleteFrame(0)">Ã—</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ–‡å­—å†…å®¹ï¼ˆæ”¯æŒå¤šè¡Œï¼‰</label>
                        <textarea class="form-input text-input" maxlength="50">ä½ å¥½
ä¸–ç•Œ</textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ–‡å­—å¤§å°ï¼ˆåƒç´ ï¼‰</label>
                        <input type="number" class="form-input size-input" min="40" max="180" value="80">
                    </div>
                    <div class="form-group line-spacing-control">
                        <label class="form-label">è¡Œé—´è·ï¼ˆ%ï¼‰</label>
                        <input type="range" class="form-input line-spacing" min="50" max="200" value="150">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ç²’å­å¯†åº¦ï¼ˆè¶Šå°è¶Šå¯†ï¼‰</label>
                        <input type="number" class="form-input density-input" min="3" max="20" value="6">
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ—¶é—´æ§åˆ¶</label>
                        <div class="timing-controls">
                            <div class="timing-control">
                                <label class="form-label">å¼€å§‹æ—¶é—´ï¼ˆç§’ï¼‰</label>
                                <input type="number" class="form-input start-time" min="0" step="0.5" value="0">
                            </div>
                            <div class="timing-control">
                                <label class="form-label">åœç•™æ—¶é—´ï¼ˆç§’ï¼‰</label>
                                <input type="number" class="form-input duration-input" min="0.5" step="0.5" value="2">
                            </div>
                        </div>
                    </div>
                    <div class="form-group transition-control">
                        <label class="form-label">è¿‡æ¸¡æ—¶é—´ï¼ˆç§’ï¼‰</label>
                        <input type="number" class="form-input transition-time" min="0.1" max="3" step="0.1" value="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ä½ç½®è°ƒæ•´</label>
                        <div class="position-controls">
                            <div class="position-control">
                                <label class="form-label">Xè½´</label>
                                <input type="range" class="form-input x-position" min="-100" max="100" value="0">
                            </div>
                            <div class="position-control">
                                <label class="form-label">Yè½´</label>
                                <input type="range" class="form-input y-position" min="-100" max="100" value="0">
                            </div>
                            <div class="position-control">
                                <label class="form-label">Zè½´åç§»</label>
                                <input type="range" class="form-input z-offset" min="-50" max="50" value="0">
                            </div>
                        </div>
                    </div>
                    <div class="form-label">Zè½´åˆ†å¸ƒæ¨¡å¼</div>
                    <div class="z-axis-mode">
                        <label class="radio-label">
                            <input type="radio" class="radio-input z-axis-mode-radio" name="zMode0" value="random" checked> éšæœºåˆ†å¸ƒ
                        </label>
                        <label class="radio-label">
                            <input type="radio" class="radio-input z-axis-mode-radio" name="zMode0" value="x-dependent"> éšXè½´å˜åŒ–
                        </label>
                        <label class="radio-label">
                            <input type="radio" class="radio-input z-axis-mode-radio" name="zMode0" value="y-dependent"> éšYè½´å˜åŒ–
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Zè½´æ·±åº¦èŒƒå›´</label>
                        <input type="range" class="form-input z-range" min="10" max="100" value="30">
                    </div>
                    <div class="form-label">é¢œè‰²æ¨¡å¼</div>
                    <div class="color-mode">
                        <label class="radio-label">
                            <input type="radio" class="radio-input color-mode-radio" name="colorMode0" value="single" checked> å•è‰²
                        </label>
                        <label class="radio-label">
                            <input type="radio" class="radio-input color-mode-radio" name="colorMode0" value="gradient"> æ¸å˜
                        </label>
                    </div>
                    <div class="form-label">é¢œè‰²é€‰æ‹©</div>
                    <div class="gradient-colors">
                        <div class="color-input-wrapper">
                            <span class="color-label">é¢œè‰²1</span>
                            <input type="color" class="color-input color-1" value="#3b82f6">
                        </div>
                        <div class="color-input-wrapper" style="display:none">
                            <span class="color-label">é¢œè‰²2</span>
                            <input type="color" class="color-input color-2" value="#8b5cf6">
                        </div>
                        <div class="color-input-wrapper" style="display:none">
                            <span class="color-label">é¢œè‰²3</span>
                            <input type="color" class="color-input color-3" value="#ec4899">
                        </div>
                    </div>
                    <div class="gradient-type" style="display:none">
                        <label class="radio-label">
                            <input type="radio" class="radio-input gradient-type-radio" name="gradientType0" value="linear-x" checked> Xè½´çº¿æ€§æ¸å˜
                        </label>
                        <label class="radio-label">
                            <input type="radio" class="radio-input gradient-type-radio" name="gradientType0" value="linear-y"> Yè½´çº¿æ€§æ¸å˜
                        </label>
                        <label class="radio-label">
                            <input type="radio" class="radio-input gradient-type-radio" name="gradientType0" value="radial"> å¾„å‘æ¸å˜
                        </label>
                        <label class="radio-label">
                            <input type="radio" class="radio-input gradient-type-radio" name="gradientType0" value="random"> éšæœºæ¸å˜
                        </label>
                    </div>

                    <div class="effects-section">
                        <div class="effects-title">ç²’å­ç‰¹æ•ˆ</div>
                        <div class="form-group">
                            <label class="form-label">å°¾è¿¹é•¿åº¦</label>
                            <input type="range" class="form-input trail-length" min="0" max="10" value="3">
                        </div>
                        <div class="form-group">
                            <label class="form-label">é—ªçƒå¼ºåº¦</label>
                            <input type="range" class="form-input flicker-intensity" min="0" max="10" value="5">
                        </div>
                    </div>
                </div>
                <!-- åˆå§‹å¸§2 -->
                <div class="frame-card" data-index="1">
                    <div class="frame-header">
                        <div class="frame-index">å¸§ 2</div>
                        <div class="frame-actions">
                            <button class="frame-btn preview" onclick="previewFrame(1)">ğŸ‘</button>
                            <button class="frame-btn delete" onclick="deleteFrame(1)">Ã—</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ–‡å­—å†…å®¹ï¼ˆæ”¯æŒå¤šè¡Œï¼‰</label>
                        <textarea class="form-input text-input" maxlength="50">3D
ç²’å­
è¡¨æ¼”</textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ–‡å­—å¤§å°ï¼ˆåƒç´ ï¼‰</label>
                        <input type="number" class="form-input size-input" min="40" max="180" value="70">
                    </div>
                    <div class="form-group line-spacing-control">
                        <label class="form-label">è¡Œé—´è·ï¼ˆ%ï¼‰</label>
                        <input type="range" class="form-input line-spacing" min="50" max="200" value="130">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ç²’å­å¯†åº¦ï¼ˆè¶Šå°è¶Šå¯†ï¼‰</label>
                        <input type="number" class="form-input density-input" min="3" max="20" value="6">
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ—¶é—´æ§åˆ¶</label>
                        <div class="timing-controls">
                            <div class="timing-control">
                                <label class="form-label">å¼€å§‹æ—¶é—´ï¼ˆç§’ï¼‰</label>
                                <input type="number" class="form-input start-time" min="0" step="0.5" value="3">
                            </div>
                            <div class="timing-control">
                                <label class="form-label">åœç•™æ—¶é—´ï¼ˆç§’ï¼‰</label>
                                <input type="number" class="form-input duration-input" min="0.5" step="0.5" value="2">
                            </div>
                        </div>
                    </div>
                    <div class="form-group transition-control">
                        <label class="form-label">è¿‡æ¸¡æ—¶é—´ï¼ˆç§’ï¼‰</label>
                        <input type="number" class="form-input transition-time" min="0.1" max="3" step="0.1" value="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ä½ç½®è°ƒæ•´</label>
                        <div class="position-controls">
                            <div class="position-control">
                                <label class="form-label">Xè½´</label>
                                <input type="range" class="form-input x-position" min="-100" max="100" value="0">
                            </div>
                            <div class="position-control">
                                <label class="form-label">Yè½´</label>
                                <input type="range" class="form-input y-position" min="-100" max="100" value="10">
                            </div>
                            <div class="position-control">
                                <label class="form-label">Zè½´åç§»</label>
                                <input type="range" class="form-input z-offset" min="-50" max="50" value="10">
                            </div>
                        </div>
                    </div>
                    <div class="form-label">Zè½´åˆ†å¸ƒæ¨¡å¼</div>
                    <div class="z-axis-mode">
                        <label class="radio-label">
                            <input type="radio" class="radio-input z-axis-mode-radio" name="zMode1" value="random"> éšæœºåˆ†å¸ƒ
                        </label>
                        <label class="radio-label">
                            <input type="radio" class="radio-input z-axis-mode-radio" name="zMode1" value="x-dependent" checked> éšXè½´å˜åŒ–
                        </label>
                        <label class="radio-label">
                            <input type="radio" class="radio-input z-axis-mode-radio" name="zMode1" value="y-dependent"> éšYè½´å˜åŒ–
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Zè½´æ·±åº¦èŒƒå›´</label>
                        <input type="range" class="form-input z-range" min="10" max="100" value="40">
                    </div>
                    <div class="form-label">é¢œè‰²æ¨¡å¼</div>
                    <div class="color-mode">
                        <label class="radio-label">
                            <input type="radio" class="radio-input color-mode-radio" name="colorMode1" value="single"> å•è‰²
                        </label>
                        <label class="radio-label">
                            <input type="radio" class="radio-input color-mode-radio" name="colorMode1" value="gradient" checked> æ¸å˜
                        </label>
                    </div>
                    <div class="form-label">é¢œè‰²é€‰æ‹©</div>
                    <div class="gradient-colors">
                        <div class="color-input-wrapper">
                            <span class="color-label">é¢œè‰²1</span>
                            <input type="color" class="color-input color-1" value="#10b981">
                        </div>
                        <div class="color-input-wrapper">
                            <span class="color-label">é¢œè‰²2</span>
                            <input type="color" class="color-input color-2" value="#3b82f6">
                        </div>
                        <div class="color-input-wrapper">
                            <span class="color-label">é¢œè‰²3</span>
                            <input type="color" class="color-input color-3" value="#8b5cf6">
                        </div>
                    </div>
                    <div class="gradient-type">
                        <label class="radio-label">
                            <input type="radio" class="radio-input gradient-type-radio" name="gradientType1" value="linear-x"> Xè½´çº¿æ€§æ¸å˜
                        </label>
                        <label class="radio-label">
                            <input type="radio" class="radio-input gradient-type-radio" name="gradientType1" value="linear-y" checked> Yè½´çº¿æ€§æ¸å˜
                        </label>
                        <label class="radio-label">
                            <input type="radio" class="radio-input gradient-type-radio" name="gradientType1" value="radial"> å¾„å‘æ¸å˜
                        </label>
                        <label class="radio-label">
                            <input type="radio" class="radio-input gradient-type-radio" name="gradientType1" value="random"> éšæœºæ¸å˜
                        </label>
                    </div>

                    <div class="effects-section">
                        <div class="effects-title">ç²’å­ç‰¹æ•ˆ</div>
                        <div class="form-group">
                            <label class="form-label">å°¾è¿¹é•¿åº¦</label>
                            <input type="range" class="form-input trail-length" min="0" max="10" value="4">
                        </div>
                        <div class="form-group">
                            <label class="form-label">é—ªçƒå¼ºåº¦</label>
                            <input type="range" class="form-input flicker-intensity" min="0" max="10" value="4">
                        </div>
                    </div>
                </div>
                <!-- æ·»åŠ å¸§æŒ‰é’® -->
                <button class="add-frame-btn" id="addFrameBtn">
                    <div class="add-frame-icon">+</div>
                    <div>æ·»åŠ æ–°å¸§</div>
                </button>
            </div>
        </div>
    </div>

    <script>
        // 1. Three.jsæ ¸å¿ƒåˆå§‹åŒ–
        const scene = new THREE.Scene();
        const container = document.getElementById('scene-container');
        let width = window.innerWidth;
        let height = window.innerHeight;

        // é€è§†ç›¸æœºï¼ˆå¢å¼ºæ™¯æ·±æ•ˆæœï¼‰
        const camera = new THREE.PerspectiveCamera(70, width / height, 0.1, 2000);
        camera.position.z = 200;

        // WebGLæ¸²æŸ“å™¨ï¼ˆå¼€å¯æŠ—é”¯é½¿ï¼‰
        const renderer = new THREE.WebGLRenderer({
            antialias: true,
            alpha: true
        });
        renderer.setSize(width, height);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // é™åˆ¶é«˜åˆ†è¾¨ç‡æ¸²æŸ“å‹åŠ›
        renderer.setClearColor(0x020617);
        container.appendChild(renderer.domElement);

        // 2. ç²’å­ç³»ç»Ÿæ ¸å¿ƒå˜é‡
        let particleSystem = null; // å½“å‰ç²’å­ç³»ç»Ÿ
        let particleGeometry = null;
        let particleMaterial = null;
        let particles = []; // ç²’å­ä½ç½®å’Œé¢œè‰²æ•°æ®
        let particleTrails = []; // ç²’å­å°¾è¿¹æ•°æ®
        let frameData = []; // å­˜å‚¨æ‰€æœ‰å¸§æ•°æ®
        let activeFrames = []; // å½“å‰æ¿€æ´»çš„å¸§ï¼ˆå¯èƒ½æœ‰å¤šä¸ªåŒæ—¶æ¿€æ´»çš„å¸§ï¼‰
        let currentTime = 0; // å½“å‰æ’­æ”¾æ—¶é—´ï¼ˆç§’ï¼‰
        let totalDuration = 0; // æ€»åŠ¨ç”»æ—¶é•¿ï¼ˆç§’ï¼‰
        let isPlaying = false; // æ’­æ”¾çŠ¶æ€
        let playTimer = null; // æ’­æ”¾è®¡æ—¶å™¨
        let playSpeed = 1; // æ’­æ”¾é€Ÿåº¦
        let rotationX = 0, rotationY = 0; // æ—‹è½¬è§’åº¦
        let isDragging = false;
        let lastX, lastY;
        let isEditorOpen = false; // ç¼–è¾‘é¢æ¿çŠ¶æ€
        let globalTime = 0; // å…¨å±€æ—¶é—´å˜é‡ï¼Œç”¨äºæ›¿ä»£ç€è‰²å™¨ä¸­çš„time

        // 3. åˆå§‹åŒ–å¸§æ•°æ®
        function initFrameData() {
            const frameCards = document.querySelectorAll('.frame-card');
            frameCards.forEach((card, index) => {
                frameData.push(getFrameDataFromCard(card, index));

                // ä¸ºé¢œè‰²æ¨¡å¼å’ŒZè½´æ¨¡å¼æ·»åŠ äº‹ä»¶ç›‘å¬
                setupModeListeners(card, index);
            });

            // è®¡ç®—æ€»æ—¶é•¿
            calculateTotalDuration();

            // åˆå§‹æ¸²æŸ“ç¬¬ä¸€å¸§
            renderFrame(0);
        }

        // è®¡ç®—æ€»åŠ¨ç”»æ—¶é•¿
        function calculateTotalDuration() {
            if (frameData.length === 0) {
                totalDuration = 0;
                return;
            }

            // æ€»æ—¶é•¿ä¸ºæœ€åä¸€å¸§çš„ç»“æŸæ—¶é—´
            const lastFrameEndTime = Math.max(...frameData.map(frame =>
                frame.startTime + frame.duration
            ));
            totalDuration = lastFrameEndTime;
        }

        // è®¾ç½®æ¨¡å¼åˆ‡æ¢ç›‘å¬ï¼ˆé¢œè‰²å’ŒZè½´ï¼‰
        function setupModeListeners(card, index) {
            // é¢œè‰²æ¨¡å¼ç›‘å¬
            const colorRadioInputs = card.querySelectorAll('.color-mode-radio');
            const colorInputs = card.querySelectorAll('.color-input-wrapper');
            const gradientType = card.querySelector('.gradient-type');

            // Zè½´æ¨¡å¼ç›‘å¬
            const zRadioInputs = card.querySelectorAll('.z-axis-mode-radio');

            // æ˜¾ç¤º/éšè—ç›¸å…³æ§ä»¶
            function updateColorControls() {
                const isGradient = card.querySelector('.color-mode-radio[value="gradient"]').checked;

                // æ˜¾ç¤ºç¬¬ä¸€ä¸ªé¢œè‰²é€‰æ‹©å™¨ï¼Œæ ¹æ®æ¨¡å¼æ˜¾ç¤ºå…¶ä»–
                for (let i = 0; i < colorInputs.length; i++) {
                    colorInputs[i].style.display = i === 0 || isGradient ? 'block' : 'none';
                }

                gradientType.style.display = isGradient ? 'flex' : 'none';
            }

            // åˆå§‹æ›´æ–°
            updateColorControls();

            // é¢œè‰²æ¨¡å¼äº‹ä»¶ç›‘å¬
            colorRadioInputs.forEach(input => {
                input.addEventListener('change', () => {
                    updateColorControls();
                    if (index === currentFrameIndex) {
                        frameData[index] = getFrameDataFromCard(card, index);
                    }
                });
            });

            // Zè½´æ¨¡å¼äº‹ä»¶ç›‘å¬
            zRadioInputs.forEach(input => {
                input.addEventListener('change', () => {
                    if (index === currentFrameIndex) {
                        frameData[index] = getFrameDataFromCard(card, index);
                        // å®æ—¶æ›´æ–°å½“å‰å¸§çš„Zè½´æ•ˆæœ
                        renderFrame(index);
                    }
                });
            });
        }

        // ä»å¸§å¡ç‰‡è·å–æ•°æ®
        function getFrameDataFromCard(card, index) {
            const text = card.querySelector('.text-input').value.trim() || `${index + 1}`;
            const size = parseInt(card.querySelector('.size-input').value) || 80;
            const lineSpacing = parseInt(card.querySelector('.line-spacing').value) || 150;
            const duration = parseFloat(card.querySelector('.duration-input').value) || 2;
            const startTime = parseFloat(card.querySelector('.start-time').value) || 0;
            const transitionTime = parseFloat(card.querySelector('.transition-time').value) || 1;
            const density = parseInt(card.querySelector('.density-input').value) || 6;
            const xPos = parseInt(card.querySelector('.x-position').value) || 0;
            const yPos = parseInt(card.querySelector('.y-position').value) || 0;
            const zOffset = parseInt(card.querySelector('.z-offset').value) || 0;
            const zMode = card.querySelector('.z-axis-mode-radio:checked').value;
            const zRange = parseInt(card.querySelector('.z-range').value) || 30;
            const colorMode = card.querySelector('.color-mode-radio:checked').value;
            const colors = [
                card.querySelector('.color-1').value,
                card.querySelector('.color-2')?.value || card.querySelector('.color-1').value,
                card.querySelector('.color-3')?.value || card.querySelector('.color-1').value
            ];
            const gradientType = colorMode === 'gradient' ?
                card.querySelector('.gradient-type-radio:checked').value : 'linear-x';
            const trailLength = parseInt(card.querySelector('.trail-length').value) || 3;
            const flickerIntensity = parseInt(card.querySelector('.flicker-intensity').value) / 10 || 0.5;

            return {
                text,
                size,
                lineSpacing,
                duration,
                startTime,
                transitionTime,
                density,
                position: { x: xPos, y: yPos, z: zOffset },
                zMode,
                zRange,
                colorMode,
                colors,
                gradientType,
                trailLength,
                flickerIntensity,
                // è®¡ç®—ç»“æŸæ—¶é—´
                endTime: startTime + duration
            };
        }

        // 4. æ–‡å­—è½¬3Dç²’å­ï¼ˆæ ¸å¿ƒæ¸²æŸ“å‡½æ•°ï¼Œæ”¯æŒå¤šè¡Œæ–‡æœ¬ï¼‰
        function textToParticles(text, size, lineSpacing, density, position, zMode, zRange, colorMode, colors, gradientType, isTarget = false) {
            // åˆ›å»ºä¸´æ—¶Canvasç”Ÿæˆæ–‡å­—åƒç´ 
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            // æŒ‰æ¢è¡Œç¬¦åˆ†å‰²æ–‡æœ¬ä¸ºå¤šè¡Œ
            const lines = text.split('\n').filter(line => line.trim() !== '');
            const lineCount = Math.max(lines.length, 1); // è‡³å°‘ä¸€è¡Œ

            // è®¡ç®—è¡Œé«˜å’Œæ€»é«˜åº¦
            const lineHeight = size * 1.2; // è¡Œé«˜ä¸ºå­—å·çš„1.2å€
            const spacingMultiplier = lineSpacing / 100; // è¡Œé—´è·ç™¾åˆ†æ¯”è½¬ä¸ºå€æ•°
            const totalTextHeight = lineHeight * lineCount + (lineCount - 1) * lineHeight * (spacingMultiplier - 1);

            // è®¾ç½®ç”»å¸ƒå¤§å° - æ ¹æ®æ–‡å­—å†…å®¹è‡ªåŠ¨è°ƒæ•´
            canvas.width = 1200; // è¶³å¤Ÿå®½ä»¥å®¹çº³é•¿æ–‡æœ¬
            canvas.height = Math.max(300, totalTextHeight + 100); // ç¡®ä¿è¶³å¤Ÿé«˜åº¦

            // æ¸…é™¤ç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // è®¾ç½®æ–‡å­—æ ·å¼
            ctx.font = `bold ${size}px Arial, sans-serif`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top'; // ä½¿ç”¨topåŸºçº¿ä¾¿äºå¤šè¡Œè®¡ç®—
            ctx.fillStyle = '#fff';

            // è®¡ç®—ç¬¬ä¸€è¡Œçš„Yåæ ‡ï¼ˆå±…ä¸­æ˜¾ç¤ºï¼‰
            const firstLineY = (canvas.height - totalTextHeight) / 2;

            // ç»˜åˆ¶æ¯è¡Œæ–‡å­—
            lines.forEach((line, i) => {
                const y = firstLineY + i * lineHeight * spacingMultiplier;
                ctx.fillText(line, canvas.width / 2, y);
            });

            // è·å–åƒç´ æ•°æ®
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height).data;

            // å¤„ç†é¢œè‰²
            const colorValues = colors.map(color => new THREE.Color(color));

            // ç”Ÿæˆç²’å­æ•°æ®
            const particleData = [];
            // è®¡ç®—ç”»å¸ƒä¸­å¿ƒï¼Œç”¨äºç›¸å¯¹ä½ç½®è®¡ç®—
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;

            // è°ƒæ•´å¯†åº¦è®¡ç®—æ–¹å¼ï¼Œç¡®ä¿è¶³å¤Ÿçš„ç²’å­æ•°é‡
            const adjustedDensity = Math.max(2, density);

            for (let y = 0; y < canvas.height; y += adjustedDensity) {
                for (let x = 0; x < canvas.width; x += adjustedDensity) {
                    const index = (y * canvas.width + x) * 4;
                    const alpha = imageData[index + 3];

                    if (alpha > 100) { // åªå–ä¸é€æ˜çš„åƒç´ 
                        // è®¡ç®—3Dåæ ‡å¹¶åº”ç”¨ä½ç½®åç§»ï¼ˆç¼©æ”¾å› å­è°ƒæ•´ä¸ºæ›´åˆé€‚çš„å€¼ï¼‰
                        const posX = ((x - centerX) / 6) + position.x;
                        const posY = ((centerY - y) / 6) + position.y;

                        // æ ¹æ®é€‰æ‹©çš„Zè½´æ¨¡å¼è®¡ç®—Zå€¼
                        let posZ;
                        const halfRange = zRange / 2;

                        switch (zMode) {
                            case 'x-dependent':
                                // Zè½´éšXè½´å˜åŒ–ï¼ˆå·¦å³æ·±åº¦ä¸åŒï¼‰
                                const xRatio = (x - centerX) / centerX; // -1åˆ°1ä¹‹é—´
                                posZ = xRatio * halfRange + position.z;
                                break;
                            case 'y-dependent':
                                // Zè½´éšYè½´å˜åŒ–ï¼ˆä¸Šä¸‹æ·±åº¦ä¸åŒï¼‰
                                const yRatio = (y - centerY) / centerY; // -1åˆ°1ä¹‹é—´
                                posZ = yRatio * halfRange + position.z;
                                break;
                            case 'random':
                            default:
                                // éšæœºZè½´åˆ†å¸ƒ
                                posZ = (Math.random() - 0.5) * zRange + position.z;
                                break;
                        }

                        // ç¡®å®šç²’å­é¢œè‰²ï¼ˆä¿®å¤æ¸å˜é¢œè‰²æ•ˆæœï¼‰
                        let color;
                        if (colorMode === 'single') {
                            // å•è‰²æ¨¡å¼
                            color = colorValues[0].clone();
                        } else {
                            // æ¸å˜æ¨¡å¼ï¼Œæ”¯æŒå¤šç§æ¸å˜æ–¹å¼
                            if (gradientType === 'linear-x') {
                                // Xè½´çº¿æ€§æ¸å˜
                                const ratio = Math.min(1, Math.max(0, x / canvas.width)) * (colorValues.length - 1);
                                const colorIndex = Math.floor(ratio);
                                const blend = ratio - colorIndex;
                                if (colorIndex < colorValues.length - 1) {
                                    color = colorValues[colorIndex].clone().lerp(colorValues[colorIndex + 1], blend);
                                } else {
                                    color = colorValues[colorValues.length - 1].clone();
                                }
                            } else if (gradientType === 'linear-y') {
                                // Yè½´çº¿æ€§æ¸å˜
                                const ratio = Math.min(1, Math.max(0, y / canvas.height)) * (colorValues.length - 1);
                                const colorIndex = Math.floor(ratio);
                                const blend = ratio - colorIndex;
                                if (colorIndex < colorValues.length - 1) {
                                    color = colorValues[colorIndex].clone().lerp(colorValues[colorIndex + 1], blend);
                                } else {
                                    color = colorValues[colorValues.length - 1].clone();
                                }
                            } else if (gradientType === 'radial') {
                                // å¾„å‘æ¸å˜ï¼ˆåŸºäºä¸­å¿ƒè·ç¦»ï¼‰
                                const distance = Math.sqrt(Math.pow(x - centerX, 2) + Math.pow(y - centerY, 2));
                                const maxDistance = Math.sqrt(Math.pow(centerX, 2) + Math.pow(centerY, 2));
                                const ratio = Math.min(1, Math.max(0, distance / maxDistance)) * (colorValues.length - 1);
                                const colorIndex = Math.floor(ratio);
                                const blend = ratio - colorIndex;
                                if (colorIndex < colorValues.length - 1) {
                                    color = colorValues[colorIndex].clone().lerp(colorValues[colorIndex + 1], blend);
                                } else {
                                    color = colorValues[colorValues.length - 1].clone();
                                }
                            } else if (gradientType === 'random') {
                                // éšæœºæ¸å˜
                                const randomIndex = Math.floor(Math.random() * colorValues.length);
                                color = colorValues[randomIndex].clone();
                            } else {
                                // é»˜è®¤ä½¿ç”¨ç¬¬ä¸€ç§é¢œè‰²
                                color = colorValues[0].clone();
                            }
                        }

                        // æ·»åŠ ç²’å­å¤§å°éšæœºå˜åŒ–ï¼Œå¢å¼ºçœŸå®æ„Ÿ
                        const particleSize = 1.2 + Math.random() * 1.3;

                        particleData.push({
                            position: new THREE.Vector3(posX, posY, posZ),
                            color: color,
                            size: particleSize,
                            // å­˜å‚¨åˆå§‹éšæœºå€¼ç”¨äºç‰¹æ•ˆ
                            random: Math.random()
                        });
                    }
                }
            }

            // ç¡®ä¿æœ‰ç²’å­ç”Ÿæˆï¼Œé¿å…ç©ºåœºæ™¯
            if (particleData.length === 0) {
                console.warn('æœªç”Ÿæˆä»»ä½•ç²’å­ï¼Œè¯·æ£€æŸ¥æ–‡å­—å†…å®¹å’Œå¯†åº¦è®¾ç½®');
                // æ·»åŠ ä¸€ä¸ªé»˜è®¤ç²’å­ï¼Œé¿å…å®Œå…¨ç©ºç™½
                particleData.push({
                    position: new THREE.Vector3(position.x, position.y, position.z),
                    color: colorValues[0].clone(),
                    size: 5,
                    random: Math.random()
                });
                showStatusHint('æœªæ£€æµ‹åˆ°æœ‰æ•ˆæ–‡å­—åƒç´ ï¼Œè¯·è°ƒæ•´æ–‡å­—æˆ–å‡å°ç²’å­å¯†åº¦');
            }

            return particleData;
        }

        // æ›´æ–°ç²’å­ç³»ç»Ÿ
        function updateParticleSystem() {
            // æ¸…é™¤æ—§ç²’å­ç³»ç»Ÿ
            if (particleSystem) {
                scene.remove(particleSystem);
                if (particleGeometry) particleGeometry.dispose();
                if (particleMaterial) particleMaterial.dispose();
            }

            // åˆå¹¶æ‰€æœ‰æ¿€æ´»å¸§çš„ç²’å­
            let allParticles = [];

            activeFrames.forEach(frame => {
                // è®¡ç®—å½“å‰å¸§çš„æ˜¾ç¤ºæ¯”ä¾‹ï¼ˆç”¨äºæ·¡å…¥æ·¡å‡ºæ•ˆæœï¼‰
                let alpha = 1;
                const transitionInStart = frame.startTime;
                const transitionInEnd = frame.startTime + frame.transitionTime;
                const transitionOutStart = frame.endTime - frame.transitionTime;
                const transitionOutEnd = frame.endTime;

                // æ·¡å…¥é˜¶æ®µ
                if (currentTime < transitionInEnd && currentTime >= transitionInStart) {
                    alpha = (currentTime - transitionInStart) / frame.transitionTime;
                }
                // æ·¡å‡ºé˜¶æ®µ
                else if (currentTime < transitionOutEnd && currentTime >= transitionOutStart) {
                    alpha = 1 - (currentTime - transitionOutStart) / frame.transitionTime;
                }
                // å®Œå…¨ä¸åœ¨æ—¶é—´èŒƒå›´å†…
                else if (currentTime < transitionInStart || currentTime >= transitionOutEnd) {
                    alpha = 0;
                }

                // åªæ·»åŠ å¯è§çš„ç²’å­
                if (alpha > 0) {
                    frame.particles.forEach(particle => {
                        allParticles.push({
                            ...particle,
                            alpha: alpha
                        });
                    });
                }
            });

            // åˆ›å»ºæ–°çš„ç²’å­å‡ ä½•
            particleGeometry = new THREE.BufferGeometry();
            const positions = [];
            const colors = [];
            const sizes = [];
            const alphas = [];

            // æ”¶é›†ä¸»ç²’å­å’Œå°¾è¿¹ç²’å­
            allParticles.forEach(particle => {
                // æŸ¥æ‰¾è¯¥ç²’å­æ‰€å±çš„å¸§ä»¥è·å–ç‰¹æ•ˆè®¾ç½®
                const frame = activeFrames.find(f =>
                    f.particles.some(p => p.random === particle.random)
                );
                const trailLength = frame ? frame.trailLength : 0;

                // æ·»åŠ ä¸»ç²’å­
                positions.push(particle.position.x, particle.position.y, particle.position.z);
                colors.push(particle.color.r, particle.color.g, particle.color.b);
                sizes.push(particle.size);
                alphas.push(particle.alpha);

                // æ·»åŠ å°¾è¿¹ç²’å­
                if (trailLength > 0 && particle.trail) {
                    particle.trail.forEach((trail, tIndex) => {
                        // å°¾è¿¹éšæ—¶é—´é€æ¸å˜å°å˜é€æ˜
                        const trailRatio = 1 - (tIndex / trailLength);
                        positions.push(trail.x, trail.y, trail.z);
                        colors.push(particle.color.r, particle.color.g, particle.color.b);
                        sizes.push(particle.size * trailRatio * 0.7);
                        alphas.push(particle.alpha * 0.5 * trailRatio);
                    });
                }
            });

            if (positions.length === 0) {
                // å¦‚æœæ²¡æœ‰ç²’å­ï¼Œä¸åˆ›å»ºæ–°çš„ç²’å­ç³»ç»Ÿ
                return;
            }

            particleGeometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            particleGeometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            particleGeometry.setAttribute('size', new THREE.Float32BufferAttribute(sizes, 1));
            particleGeometry.setAttribute('alpha', new THREE.Float32BufferAttribute(alphas, 1));
            // æ·»åŠ éšæœºå€¼å±æ€§ç”¨äºé—ªçƒåŠ¨ç”»
            particleGeometry.setAttribute('random', new THREE.Float32BufferAttribute(
                allParticles.flatMap(p => {
                    const vals = [p.random];
                    // ä¸ºæ¯ä¸ªå°¾è¿¹ç²’å­æ·»åŠ ç›¸åŒçš„éšæœºå€¼
                    if (p.trail && p.trail.length > 0) {
                        for (let i = 0; i < p.trail.length; i++) {
                            vals.push(p.random);
                        }
                    }
                    return vals;
                }), 1)
            );

            // åˆ›å»ºç²’å­æè´¨
            particleMaterial = new THREE.ShaderMaterial({
                uniforms: {
                    pointTexture: { value: new THREE.TextureLoader().load('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==') },
                    flickerIntensity: { value: 0.5 },
                    globalTime: { value: globalTime }
                },
                vertexShader: `
                                attribute float size;
                                attribute vec3 color;
                                attribute float alpha;
                                attribute float random;
                                varying vec3 vColor;
                                varying float vAlpha;
                                varying float vRandom;
                                void main() {
                                    vColor = color;
                                    vAlpha = alpha;
                                    vRandom = random;
                                    vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
                                    gl_PointSize = size * (200.0 / -mvPosition.z);
                                    gl_Position = projectionMatrix * mvPosition;
                                }
                            `,
                fragmentShader: `
                                varying vec3 vColor;
                                varying float vAlpha;
                                varying float vRandom;
                                uniform sampler2D pointTexture;
                                uniform float flickerIntensity;
                                uniform float globalTime;

                                void main() {
                                    // ä½¿ç”¨ç²’å­éšæœºå€¼å’Œå…¨å±€æ—¶é—´åˆ›å»ºæ›´è‡ªç„¶çš„é—ªçƒæ•ˆæœ
                                    float flicker = 1.0 + (sin((globalTime + vRandom * 10.0) * 5.0) * 0.5 - 0.5) * flickerIntensity;
                                    gl_FragColor = vec4(vColor * flicker, vAlpha);
                                    gl_FragColor = gl_FragColor * texture2D(pointTexture, gl_PointCoord);
                                }
                            `,
                transparent: true,
                blending: THREE.AdditiveBlending,
                depthWrite: false,
                uniformsNeedUpdate: true
            });

            // åˆ›å»ºç‚¹ç³»ç»Ÿå¹¶æ·»åŠ åˆ°åœºæ™¯
            particleSystem = new THREE.Points(particleGeometry, particleMaterial);
            particleSystem.rotation.x = rotationX;
            particleSystem.rotation.y = rotationY;
            scene.add(particleSystem);
        }

        // æ›´æ–°ç²’å­å°¾è¿¹
        function updateParticleTrails() {
            activeFrames.forEach(frame => {
                if (frame.trailLength <= 0) return;

                frame.particles.forEach(particle => {
                    if (!particle.trail) particle.trail = [];

                    // è®°å½•å½“å‰ä½ç½®ä½œä¸ºæ–°çš„å°¾è¿¹ç‚¹
                    particle.trail.unshift(new THREE.Vector3(
                        particle.position.x,
                        particle.position.y,
                        particle.position.z
                    ));

                    // é™åˆ¶å°¾è¿¹é•¿åº¦
                    if (particle.trail.length > frame.trailLength) {
                        particle.trail.pop();
                    }
                });
            });
        }

        // 5. æ¸²æŸ“æŒ‡å®šå¸§
        function renderFrame(index) {
            if (!frameData[index]) return;

            const frame = frameData[index];
            // ç”Ÿæˆç²’å­çŠ¶æ€
            const particles = textToParticles(
                frame.text,
                frame.size,
                frame.lineSpacing,
                frame.density,
                frame.position,
                frame.zMode,
                frame.zRange,
                frame.colorMode,
                frame.colors,
                frame.gradientType
            );

            // å­˜å‚¨ç²’å­æ•°æ®åˆ°å¸§
            frame.particles = particles;

            // å¦‚æœæ˜¯é¢„è§ˆæ¨¡å¼ï¼Œåªæ˜¾ç¤ºå½“å‰å¸§
            if (isPreviewing) {
                activeFrames = [frame];
                updateParticleSystem();
            }
        }

        // é¢„è§ˆå½“å‰å¸§
        let isPreviewing = false;
        function previewFrame(index) {
            if (!frameData[index]) return;

            isPreviewing = true;

            // æ›´æ–°å¸§æ•°æ®
            const frameCard = document.querySelector(`.frame-card[data-index="${index}"]`);
            if (frameCard) {
                frameData[index] = getFrameDataFromCard(frameCard, index);
            }

            // æ¸²æŸ“è¯¥å¸§
            renderFrame(index);

            // æ˜¾ç¤ºæç¤º
            showStatusHint(`å·²é¢„è§ˆ å¸§ ${index + 1}`);

            // æš‚åœæ’­æ”¾ï¼ˆå¦‚æœæ­£åœ¨æ’­æ”¾ï¼‰
            if (isPlaying) {
                pausePlayback();
            }
        }

        // 6. æ’­æ”¾æ§åˆ¶
        function startPlayback() {
            if (isPlaying) return;

            // ç¡®ä¿æœ‰å¸§
            if (frameData.length === 0) {
                showStatusHint("è¯·æ·»åŠ è‡³å°‘1ä¸ªå¸§æ‰èƒ½æ’­æ”¾åŠ¨ç”»");
                return;
            }

            // é‡ç½®æ’­æ”¾çŠ¶æ€
            isPreviewing = false;
            currentTime = 0;

            // é¢„å…ˆç”Ÿæˆæ‰€æœ‰å¸§çš„ç²’å­æ•°æ®
            frameData.forEach((frame, index) => {
                renderFrame(index);
            });

            isPlaying = true;
            document.getElementById('playBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = false;

            // å¦‚æœç¼–è¾‘é¢æ¿æ‰“å¼€åˆ™å…³é—­
            if (isEditorOpen) {
                toggleEditor(false);
            }

            // å¼€å§‹æ’­æ”¾å¾ªç¯
            animatePlayback();
        }

        function pausePlayback() {
            if (!isPlaying) return;

            isPlaying = false;
            if (playTimer) {
                cancelAnimationFrame(playTimer);
                playTimer = null;
            }
            document.getElementById('playBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
        }

        // æ’­æ”¾å¾ªç¯å‡½æ•°
        function animatePlayback() {
            if (!isPlaying) return;

            // è®¡ç®—æ—¶é—´å¢é‡ï¼ˆåŸºäºæ’­æ”¾é€Ÿåº¦ï¼‰
            const deltaTime = 0.016 * playSpeed;
            currentTime += deltaTime;

            // æ£€æŸ¥æ˜¯å¦å¾ªç¯æ’­æ”¾
            if (currentTime >= totalDuration) {
                currentTime = 0; // é‡ç½®æ—¶é—´ï¼Œé‡æ–°å¼€å§‹
            }

            // æ›´æ–°æ¿€æ´»çš„å¸§
            updateActiveFrames();

            // æ›´æ–°ç²’å­å°¾è¿¹
            updateParticleTrails();

            // æ›´æ–°ç²’å­ç³»ç»Ÿ
            updateParticleSystem();

            // ç»§ç»­æ’­æ”¾å¾ªç¯
            playTimer = requestAnimationFrame(animatePlayback);
        }

        // æ›´æ–°å½“å‰æ¿€æ´»çš„å¸§
        function updateActiveFrames() {
            activeFrames = frameData.filter(frame => {
                // æ£€æŸ¥å½“å‰æ—¶é—´æ˜¯å¦åœ¨å¸§çš„æ—¶é—´èŒƒå›´å†…ï¼ˆåŒ…æ‹¬è¿‡æ¸¡æ—¶é—´ï¼‰
                return currentTime >= frame.startTime - frame.transitionTime / 2 &&
                    currentTime <= frame.endTime + frame.transitionTime / 2;
            });
        }

        // 7. äº¤äº’æ§åˆ¶ï¼ˆé¼ æ ‡æ‹–æ‹½æ—‹è½¬ï¼‰
        function initInteraction() {
            container.addEventListener('pointerdown', (e) => {
                if (isEditorOpen) return; // ç¼–è¾‘é¢æ¿æ‰“å¼€æ—¶ä¸å“åº”æ‹–æ‹½
                isDragging = true;
                lastX = e.clientX;
                lastY = e.clientY;
            });

            container.addEventListener('pointermove', (e) => {
                if (!isDragging || !particleSystem || isEditorOpen) return;

                const deltaX = e.clientX - lastX;
                const deltaY = e.clientY - lastY;

                // æ§åˆ¶æ—‹è½¬é€Ÿåº¦
                rotationY += deltaX * 0.005;
                rotationX -= deltaY * 0.005;
                rotationX = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, rotationX)); // é™åˆ¶ä¸Šä¸‹æ—‹è½¬

                // æ›´æ–°ç²’å­æ—‹è½¬
                particleSystem.rotation.x = rotationX;
                particleSystem.rotation.y = rotationY;

                lastX = e.clientX;
                lastY = e.clientY;
            });

            container.addEventListener('pointerup', () => isDragging = false);
            container.addEventListener('pointerleave', () => isDragging = false);

            // é‡ç½®è§†è§’
            document.getElementById('resetBtn').addEventListener('click', () => {
                rotationX = 0;
                rotationY = 0;
                if (particleSystem) {
                    particleSystem.rotation.x = rotationX;
                    particleSystem.rotation.y = rotationY;
                }
                showStatusHint("è§†è§’å·²é‡ç½®");
            });

            // æ’­æ”¾/æš‚åœæ§åˆ¶
            document.getElementById('playBtn').addEventListener('click', startPlayback);
            document.getElementById('pauseBtn').addEventListener('click', pausePlayback);

            // æ’­æ”¾é€Ÿåº¦æ§åˆ¶
            document.getElementById('playSpeed').addEventListener('input', (e) => {
                playSpeed = parseFloat(e.target.value);
                showStatusHint(`æ’­æ”¾é€Ÿåº¦: ${playSpeed}x`);
            });

            // ç¼–è¾‘é¢æ¿æ§åˆ¶
            document.getElementById('editBtn').addEventListener('click', () => {
                toggleEditor(true);
            });

            document.getElementById('closeEditorBtn').addEventListener('click', () => {
                toggleEditor(false);
            });

            document.getElementById('applyEditorBtn').addEventListener('click', () => {
                // ä¿å­˜æ‰€æœ‰å¸§æ•°æ®
                saveAllFrameData();
                // å…³é—­ç¼–è¾‘é¢æ¿
                toggleEditor(false);
                // é‡æ–°è®¡ç®—æ€»æ—¶é•¿
                calculateTotalDuration();
                // é‡æ–°æ¸²æŸ“å½“å‰å¸§
                if (frameData.length > 0) {
                    renderFrame(currentFrameIndex);
                }
                showStatusHint("æ–¹æ¡ˆå·²æ›´æ–°");
            });

            // ç‚¹å‡»é®ç½©å±‚å…³é—­ç¼–è¾‘é¢æ¿
            document.getElementById('overlay').addEventListener('click', () => {
                toggleEditor(false);
            });

            // æ·»åŠ æ–°å¸§
            document.getElementById('addFrameBtn').addEventListener('click', addNewFrame);
        }

        // åˆ‡æ¢ç¼–è¾‘é¢æ¿æ˜¾ç¤ºçŠ¶æ€
        function toggleEditor(show) {
            const drawer = document.getElementById('editorDrawer');
            const overlay = document.getElementById('overlay');
            const statusHint = document.getElementById('statusHint');

            if (show) {
                drawer.classList.add('open');
                overlay.classList.add('show');
                statusHint.textContent = "ç¼–è¾‘å¸§åºåˆ—ï¼Œå®Œæˆåç‚¹å‡»åº”ç”¨æ–¹æ¡ˆ";
                statusHint.classList.add('show');
                isEditorOpen = true;

                // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œæš‚åœ
                if (isPlaying) {
                    pausePlayback();
                }
            } else {
                drawer.classList.remove('open');
                overlay.classList.remove('show');
                statusHint.classList.remove('show');
                isEditorOpen = false;
            }
        }

        // ä¿å­˜æ‰€æœ‰å¸§æ•°æ®
        function saveAllFrameData() {
            const frameCards = document.querySelectorAll('.frame-card');
            frameData = [];
            frameCards.forEach((card, index) => {
                frameData.push(getFrameDataFromCard(card, index));
            });
        }

        // æ˜¾ç¤ºçŠ¶æ€æç¤º
        function showStatusHint(text) {
            const statusHint = document.getElementById('statusHint');
            statusHint.textContent = text;
            statusHint.classList.add('show');

            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                statusHint.classList.remove('show');
            }, 3000);
        }

        // 8. å¸§ç®¡ç†åŠŸèƒ½
        function addNewFrame() {
            const framesContainer = document.getElementById('framesContainer');
            const newIndex = frameData.length;

            // è®¡ç®—æ–°å¸§çš„é»˜è®¤å¼€å§‹æ—¶é—´ï¼ˆä¸Šä¸€å¸§çš„ç»“æŸæ—¶é—´ï¼‰
            let defaultStartTime = 0;
            if (newIndex > 0 && frameData.length > 0) {
                const lastFrame = frameData[frameData.length - 1];
                defaultStartTime = lastFrame.startTime + lastFrame.duration;
            }

            // åˆ›å»ºæ–°å¸§å¡ç‰‡
            const newFrameCard = document.createElement('div');
            newFrameCard.className = 'frame-card';
            newFrameCard.dataset.index = newIndex;
            newFrameCard.innerHTML = `
                            <div class="frame-header">
                                <div class="frame-index">å¸§ ${newIndex + 1}</div>
                                <div class="frame-actions">
                                    <button class="frame-btn preview" onclick="previewFrame(${newIndex})">ğŸ‘</button>
                                    <button class="frame-btn delete" onclick="deleteFrame(${newIndex})">Ã—</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">æ–‡å­—å†…å®¹ï¼ˆæ”¯æŒå¤šè¡Œï¼‰</label>
                                <textarea class="form-input text-input" maxlength="50">${newIndex + 1}</textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">æ–‡å­—å¤§å°ï¼ˆåƒç´ ï¼‰</label>
                                <input type="number" class="form-input size-input" min="40" max="180" value="80">
                            </div>
                            <div class="form-group line-spacing-control">
                                <label class="form-label">è¡Œé—´è·ï¼ˆ%ï¼‰</label>
                                <input type="range" class="form-input line-spacing" min="50" max="200" value="150">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ç²’å­å¯†åº¦ï¼ˆè¶Šå°è¶Šå¯†ï¼‰</label>
                                <input type="number" class="form-input density-input" min="3" max="20" value="6">
                            </div>
                            <div class="form-group">
                                <label class="form-label">æ—¶é—´æ§åˆ¶</label>
                                <div class="timing-controls">
                                    <div class="timing-control">
                                        <label class="form-label">å¼€å§‹æ—¶é—´ï¼ˆç§’ï¼‰</label>
                                        <input type="number" class="form-input start-time" min="0" step="0.5" value="${defaultStartTime}">
                                    </div>
                                    <div class="timing-control">
                                        <label class="form-label">åœç•™æ—¶é—´ï¼ˆç§’ï¼‰</label>
                                        <input type="number" class="form-input duration-input" min="0.5" step="0.5" value="2">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group transition-control">
                                <label class="form-label">è¿‡æ¸¡æ—¶é—´ï¼ˆç§’ï¼‰</label>
                                <input type="number" class="form-input transition-time" min="0.1" max="3" step="0.1" value="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ä½ç½®è°ƒæ•´</label>
                                <div class="position-controls">
                                    <div class="position-control">
                                        <label class="form-label">Xè½´</label>
                                        <input type="range" class="form-input x-position" min="-100" max="100" value="0">
                                    </div>
                                    <div class="position-control">
                                        <label class="form-label">Yè½´</label>
                                        <input type="range" class="form-input y-position" min="-100" max="100" value="0">
                                    </div>
                                    <div class="position-control">
                                        <label class="form-label">Zè½´åç§»</label>
                                        <input type="range" class="form-input z-offset" min="-50" max="50" value="0">
                                    </div>
                                </div>
                            </div>
                            <div class="form-label">Zè½´åˆ†å¸ƒæ¨¡å¼</div>
                            <div class="z-axis-mode">
                                <label class="radio-label">
                                    <input type="radio" class="radio-input z-axis-mode-radio" name="zMode${newIndex}" value="random" checked> éšæœºåˆ†å¸ƒ
                                </label>
                                <label class="radio-label">
                                    <input type="radio" class="radio-input z-axis-mode-radio" name="zMode${newIndex}" value="x-dependent"> éšXè½´å˜åŒ–
                                </label>
                                <label class="radio-label">
                                    <input type="radio" class="radio-input z-axis-mode-radio" name="zMode${newIndex}" value="y-dependent"> éšYè½´å˜åŒ–
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Zè½´æ·±åº¦èŒƒå›´</label>
                                <input type="range" class="form-input z-range" min="10" max="100" value="30">
                            </div>
                            <div class="form-label">é¢œè‰²æ¨¡å¼</div>
                            <div class="color-mode">
                                <label class="radio-label">
                                    <input type="radio" class="radio-input color-mode-radio" name="colorMode${newIndex}" value="single" checked> å•è‰²
                                </label>
                                <label class="radio-label">
                                    <input type="radio" class="radio-input color-mode-radio" name="colorMode${newIndex}" value="gradient"> æ¸å˜
                                </label>
                            </div>
                            <div class="form-label">é¢œè‰²é€‰æ‹©</div>
                            <div class="gradient-colors">
                                <div class="color-input-wrapper">
                                    <span class="color-label">é¢œè‰²1</span>
                                    <input type="color" class="color-input color-1" value="#3b82f6">
                                </div>
                                <div class="color-input-wrapper" style="display:none">
                                    <span class="color-label">é¢œè‰²2</span>
                                    <input type="color" class="color-input color-2" value="#8b5cf6">
                                </div>
                                <div class="color-input-wrapper" style="display:none">
                                    <span class="color-label">é¢œè‰²3</span>
                                    <input type="color" class="color-input color-3" value="#ec4899">
                                </div>
                            </div>
                            <div class="gradient-type" style="display:none">
                                <label class="radio-label">
                                    <input type="radio" class="radio-input gradient-type-radio" name="gradientType${newIndex}" value="linear-x" checked> Xè½´çº¿æ€§æ¸å˜
                                </label>
                                <label class="radio-label">
                                    <input type="radio" class="radio-input gradient-type-radio" name="gradientType${newIndex}" value="linear-y"> Yè½´çº¿æ€§æ¸å˜
                                </label>
                                <label class="radio-label">
                                    <input type="radio" class="radio-input gradient-type-radio" name="gradientType${newIndex}" value="radial"> å¾„å‘æ¸å˜
                                </label>
                                <label class="radio-label">
                                    <input type="radio" class="radio-input gradient-type-radio" name="gradientType${newIndex}" value="random"> éšæœºæ¸å˜
                                </label>
                            </div>

                            <div class="effects-section">
                                <div class="effects-title">ç²’å­ç‰¹æ•ˆ</div>
                                <div class="form-group">
                                    <label class="form-label">å°¾è¿¹é•¿åº¦</label>
                                    <input type="range" class="form-input trail-length" min="0" max="10" value="3">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">é—ªçƒå¼ºåº¦</label>
                                    <input type="range" class="form-input flicker-intensity" min="0" max="10" value="5">
                                </div>
                            </div>
                        `;

            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            newFrameCard.addEventListener('click', (e) => {
                if (!e.target.closest('.frame-btn')) {
                    selectFrame(newIndex);
                }
            });

            // æ·»åŠ è¾“å…¥å˜åŒ–äº‹ä»¶
            const inputs = newFrameCard.querySelectorAll('input:not(.color-mode-radio):not(.z-axis-mode-radio):not(.gradient-type-radio), textarea');
            inputs.forEach(input => {
                input.addEventListener('input', () => {
                    if (newIndex === currentFrameIndex) {
                        frameData[newIndex] = getFrameDataFromCard(newFrameCard, newIndex);
                    }
                });
            });

            // ä¸ºæ¸å˜ç±»å‹æ·»åŠ äº‹ä»¶ç›‘å¬
            const gradientTypeRadios = newFrameCard.querySelectorAll('.gradient-type-radio');
            gradientTypeRadios.forEach(radio => {
                radio.addEventListener('change', () => {
                    if (newIndex === currentFrameIndex) {
                        frameData[newIndex] = getFrameDataFromCard(newFrameCard, newIndex);
                        renderFrame(newIndex);
                    }
                });
            });

            // è®¾ç½®æ¨¡å¼ç›‘å¬
            setupModeListeners(newFrameCard, newIndex);

            // æ’å…¥åˆ°å®¹å™¨ä¸­ï¼ˆæ·»åŠ å¸§æŒ‰é’®å‰ï¼‰
            framesContainer.insertBefore(newFrameCard, document.getElementById('addFrameBtn'));

            // æ›´æ–°å¸§æ•°æ®
            frameData.push(getFrameDataFromCard(newFrameCard, newIndex));

            // é€‰ä¸­æ–°å¸§
            selectFrame(newIndex);

            // æ›´æ–°æ€»æ—¶é•¿
            calculateTotalDuration();

            showStatusHint(`å·²æ·»åŠ  å¸§ ${newIndex + 1}`);
        }

        function deleteFrame(index) {
            if (frameData.length <= 1) {
                showStatusHint("è‡³å°‘ä¿ç•™1ä¸ªå¸§");
                return;
            }

            // ç§»é™¤å¸§å¡ç‰‡
            const frameCard = document.querySelector(`.frame-card[data-index="${index}"]`);
            if (frameCard) frameCard.remove();

            // æ›´æ–°å¸§æ•°æ®
            frameData.splice(index, 1);

            // æ›´æ–°å‰©ä½™å¸§çš„ç´¢å¼•å’Œäº‹ä»¶
            const remainingFrames = document.querySelectorAll('.frame-card');
            remainingFrames.forEach((card, i) => {
                card.dataset.index = i;
                card.querySelector('.frame-index').textContent = `å¸§ ${i + 1}`;
                card.querySelector('.preview').setAttribute('onclick', `previewFrame(${i})`);
                card.querySelector('.delete').setAttribute('onclick', `deleteFrame(${i})`);

                // æ›´æ–°å•é€‰æŒ‰é’®åç§°ï¼ˆé¿å…å†²çªï¼‰
                const colorModeRadios = card.querySelectorAll('.color-mode-radio');
                colorModeRadios.forEach(radio => {
                    radio.name = `colorMode${i}`;
                });

                const zModeRadios = card.querySelectorAll('.z-axis-mode-radio');
                zModeRadios.forEach(radio => {
                    radio.name = `zMode${i}`;
                });

                const gradientRadios = card.querySelectorAll('.gradient-type-radio');
                gradientRadios.forEach(radio => {
                    radio.name = `gradientType${i}`;
                });

                // é‡æ–°è®¾ç½®äº‹ä»¶ç›‘å¬
                setupModeListeners(card, i);
            });

            // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰å¸§ï¼Œåˆ‡æ¢åˆ°ç¬¬ä¸€å¸§
            if (index === currentFrameIndex) {
                const newIndex = Math.min(index, frameData.length - 1);
                selectFrame(newIndex);
                renderFrame(newIndex);
            } else if (index < currentFrameIndex) {
                // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰å¸§å‰é¢çš„å¸§ï¼Œæ›´æ–°å½“å‰ç´¢å¼•
                currentFrameIndex--;
                updateActiveFrameCard();
            }

            // æ›´æ–°æ€»æ—¶é•¿
            calculateTotalDuration();

            showStatusHint(`å·²åˆ é™¤ å¸§ ${index + 1}`);
        }

        let currentFrameIndex = 0;
        function selectFrame(index) {
            // æ›´æ–°å½“å‰å¸§ç´¢å¼•
            currentFrameIndex = index;
            updateActiveFrameCard();
        }

        function updateActiveFrameCard() {
            // ç§»é™¤æ‰€æœ‰å¸§çš„activeç±»
            document.querySelectorAll('.frame-card').forEach(card => {
                card.classList.remove('active');
            });

            // ç»™å½“å‰å¸§æ·»åŠ activeç±»
            const activeCard = document.querySelector(`.frame-card[data-index="${currentFrameIndex}"]`);
            if (activeCard) activeCard.classList.add('active');
        }

        // 9. çª—å£å¤§å°é€‚é…
        function onWindowResize() {
            width = window.innerWidth;
            height = window.innerHeight;
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
            renderer.setSize(width, height);
        }

        window.addEventListener('resize', onWindowResize);

        // 10. åŠ¨ç”»å¾ªç¯
        function animate() {
            requestAnimationFrame(animate);

            // æ›´æ–°å…¨å±€æ—¶é—´
            globalTime += 0.016;

            // æ›´æ–°ç€è‰²å™¨ä¸­çš„å…¨å±€æ—¶é—´
            if (particleMaterial && particleMaterial.uniforms) {
                particleMaterial.uniforms.globalTime.value = globalTime;
            }

            renderer.render(scene, camera);
        }

        // åˆå§‹åŒ–
        window.addEventListener('load', () => {
            initFrameData();
            initInteraction();
            animate();
        });
    </script>
</body>
</html>